<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <meta name="theme-color" content="#FFC107" />
  <title>eatmi.pl — Panel Administratora</title>
  <meta name="description" content="Panel administratora eatmi.pl" />
  <link rel="icon" type="image/png" href="favicon.png">

  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              yellow: '#FFC107',
              dark: '#111827',
              light: '#F9FAFB'
            },
            kiosk: {
              bg: '#0B0F1A',
              card: '#0F1629',
              card2: '#111B34',
              green: '#22C55E',
              red: '#EF4444',
              blue: '#3B82F6',
              violet: '#8B5CF6',
              orange: '#F59E0B',
              gray: '#94A3B8'
            }
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.08)',
            glass: '0 8px 25px rgba(0,0,0,.12)',
            kiosk: '0 14px 50px rgba(0,0,0,.35)'
          },
          borderRadius: { xl2: '1.25rem' },
          screens: {
            'xs': '375px',
            'sm': '640px',
            'md': '768px',
            'lg': '1024px',
            'xl': '1280px',
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --safe-b: env(safe-area-inset-bottom, 20px);
      --safe-t: env(safe-area-inset-top, 20px);
      --sidebar-w: 280px;
    }
    html, body { height: 100%; width: 100%; }
    body { 
      overscroll-behavior-y: none; 
      -webkit-tap-highlight-color: transparent;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .liquid { background: rgba(255,255,255,.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
    
    /* Input focus ring adjustment */
    .input-focus { outline: none; transition: box-shadow 0.2s; font-size: 16px; /* Prevents iOS zoom */ }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(255,193,7,.35); border-color: rgba(255,193,7,.75); }
    
    .toast-enter { animation: toastIn .25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes toastIn { from { transform: translateY(20px) scale(0.95); opacity: 0 } to { transform: translateY(0) scale(1); opacity: 1 } }

    /* Subtle background pattern */
    .bg-soft {
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(255,193,7,.18), transparent 55%),
        radial-gradient(700px 450px at 95% 20%, rgba(59,130,246,.10), transparent 55%),
        radial-gradient(600px 400px at 30% 110%, rgba(34,197,94,.08), transparent 55%),
        linear-gradient(#fff, #f7f8fb);
      background-attachment: fixed;
    }

    /* Drawer scroll & fix */
    .drawer-scroll { max-height: calc(100vh - 80px); overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(20px + var(--safe-b)); }

    /* Flashing alert */
    .flash-yellow { background: #FFC107; transition: background 0.1s; }
    .flash-white { background: #ffffff; transition: background 0.1s; }
    .no-interact { pointer-events: none; user-select: none; filter: blur(2px); }

    /* iOS/Safari fixed centering helpers */
    .ios-fixed {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile browsers */
    }

    /* Custom Scrollbar for desktop */
    @media (min-width: 1024px) {
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }
    }
    
    /* Animations */
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .animate-slideInRight { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
  </style>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
</head>

<body class="bg-soft text-gray-900 selection:bg-brand-yellow/30">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState, useLayoutEffect } = React;

    /* =========================================================
       API CONFIG
       ========================================================= */

    const API = {
      login: "/api/admin/login",
      stats: "/api/admin/stats",
      orders: "/api/admin/orders",
      push: "/api/admin/push",
      staff: "/api/admin/staff",
      events: "/api/admin/stream",
    };

    /* =======================
       Utils
       ======================= */

    const toNumber = (v) => {
      if (v === null || v === undefined) return 0;
      if (typeof v === "number") return v;
      if (typeof v === "string") {
        const s = v.trim().replace(",", ".");
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }
      return 0;
    };

    const toPLNFromMaybeGrosze = (value, hint = "") => {
      const n = toNumber(value);
      const h = String(hint || "").toLowerCase();
      const looksLikePayUGrosze =
        h.includes("totalamount") ||
        h.includes("unitprice") ||
        h.includes("unit_amount") ||
        h.includes("unitamount") ||
        h.includes("uniteffectiveprice") ||
        h.includes("payu");

      if (looksLikePayUGrosze) return n / 100;
      if (Number.isInteger(n) && n >= 1000 && n <= 200000) return n / 100;
      return n;
    };

    const currency = (nPln) => {
      const num = Number(nPln || 0);
      return new Intl.NumberFormat('pl-PL', { style:'currency', currency:'PLN' }).format(num);
    };

    const safeJson = async (r) => {
      try { return await r.json(); } catch { return {}; }
    };

    const authHeader = (token) => token ? { Authorization: `Bearer ${token}` } : {};

    const pickOrderId = (o, idx=0) => o?.extOrderId || o?.id || o?.orderId || o?._id || `row-${idx}`;
    const pickCreatedAt = (o) => o?.createdAt || o?.created_at || o?.date || o?.timestamp || o?.orderDate || null;

    const getOrderTotalPLN = (order) => {
      if (!order) return 0;
      if (order.totalPLN !== undefined) return toPLNFromMaybeGrosze(order.totalPLN, "pln");
      if (order.total !== undefined) return toPLNFromMaybeGrosze(order.total, "total");
      if (order.totalAmount !== undefined) return toPLNFromMaybeGrosze(order.totalAmount, "totalAmount");
      return 0;
    };

    const getItemUnitPricePLN = (it) => {
      if (!it) return 0;
      if (it.unitEffectivePrice !== undefined) return toPLNFromMaybeGrosze(it.unitEffectivePrice, "unitEffectivePrice");
      if (it.unitPrice !== undefined) return toPLNFromMaybeGrosze(it.unitPrice, "unitPrice");
      if (it.price !== undefined) return toPLNFromMaybeGrosze(it.price, "price");
      return 0;
    };

    const resolvePayment = (order) => {
      const o = order || {};
      const pmRaw = o.paymentMethod || o.paymentType || o.method || null;
      const pm = String(pmRaw || "").trim().toLowerCase();
      
      if (pm.includes("cash") || pm === "gotowka" || pm === "gotówka") {
        return { kind: "offline_cash", label: "Gotówka przy odbiorze", badge: "GOTÓWKA" };
      }
      if (pm.includes("card") || pm === "karta") {
        return { kind: "offline_card", label: "Karta przy odbiorze", badge: "KARTA" };
      }
      return { kind: "online", label: "PayU (online)", badge: "PAYU" };
    };

    const PRODUCT_NAME_MAP = {
      "bs-small-1": "Box śniadaniowy mały nr 1",
      "bs-small-2": "Box śniadaniowy mały nr 2",
      "bs-small-3": "Box śniadaniowy mały nr 3",
      "bs-small-vege": "Box śniadaniowy mały VEGE",
      "bs-med-1": "Box śniadaniowy średni nr 1",
      "bs-med-2": "Box śniadaniowy średni nr 2",
      "bs-med-3": "Box śniadaniowy średni nr 3",
      "bs-med-vege": "Box śniadaniowy średni VEGE",
      "bs-big-1": "Box śniadaniowy duży nr 1",
      "bs-big-2": "Box śniadaniowy duży nr 2",
      "bs-big-3": "Box śniadaniowy duży nr 3",
      "bs-big-vege": "Box śniadaniowy duży VEGE",
      "lunch-week": "Lunch tygodnia",
      "lunch-month": "Lunch miesiąca",
      "lunch-vege": "Lunch VEGE",
      "extra-granola": "Granola",
      "extra-lemoniada": "Lemoniada",
      "extra-deser": "Deser",
    };

    const resolveProductName = (it) => {
      const fromBackend = it?.name;
      if (fromBackend && String(fromBackend).trim()) return String(fromBackend);
      const pid = it?.productId || "";
      if (pid && PRODUCT_NAME_MAP[pid]) return PRODUCT_NAME_MAP[pid];
      return pid || "Pozycja";
    };

    /* =======================
       Global Helpers for Components
       ======================= */
    const fmtDate = (iso) => {
      if (!iso) return "—";
      try {
        const d = new Date(iso);
        return d.toLocaleString("pl-PL");
      } catch { return String(iso); }
    };
    
    // FIX: Helper to force icon refresh
    const refreshIcons = () => {
        if(window.lucide && window.lucide.createIcons) {
            window.lucide.createIcons();
        }
    };

    /* =======================
       Toast
       ======================= */
    const ToastContext = React.createContext();
    const useToast = () => React.useContext(ToastContext);

    const ToastProvider = ({ children }) => {
      const [toast, setToast] = useState(null);
      const tRef = useRef(null);

      const show = (type, title, msg) => {
        setToast({ type, title, msg });
        if (tRef.current) clearTimeout(tRef.current);
        tRef.current = setTimeout(() => setToast(null), 2600);
      };

      const close = () => {
        if (tRef.current) clearTimeout(tRef.current);
        setToast(null);
      };

      return (
        <ToastContext.Provider value={{ show }}>
          {children}
          {toast && (
            <div className="fixed bottom-[calc(18px+var(--safe-b))] left-1/2 -translate-x-1/2 z-[200] pointer-events-none w-full flex justify-center px-4">
              <div className="pointer-events-auto toast-enter bg-white/95 border border-gray-200 shadow-glass rounded-2xl px-4 py-3 min-w-[280px] max-w-md w-full flex items-start gap-3 backdrop-blur-md">
                <div className={`w-9 h-9 rounded-full grid place-items-center text-lg shrink-0 ${
                  toast.type === "ok" ? "bg-emerald-100 text-emerald-700" :
                  toast.type === "error" ? "bg-red-100 text-red-700" :
                  "bg-gray-100 text-gray-700"
                }`}>
                  {toast.type === "ok" ? "✓" : toast.type === "error" ? "!" : "i"}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-[10px] font-extrabold uppercase tracking-[0.14em] text-gray-500">
                    {toast.title || (toast.type === "ok" ? "Sukces" : toast.type === "error" ? "Błąd" : "Info")}
                  </div>
                  <div className="text-sm text-gray-900 mt-0.5 break-words font-medium">{toast.msg}</div>
                </div>
                <button
                  type="button"
                  onClick={close}
                  className="ml-2 text-gray-400 hover:text-gray-700 text-xl leading-none p-2 -mr-2"
                  aria-label="Zamknij"
                >
                  ×
                </button>
              </div>
            </div>
          )}
        </ToastContext.Provider>
      );
    };

    /* =======================
       Components: Shell
       ======================= */
    const Logo = () => (
      <div className="flex items-center gap-3">
        <div className="w-10 h-10 rounded-2xl bg-white border border-gray-200 shadow-soft grid place-items-center overflow-hidden shrink-0">
          <img
            src="https://i.imgur.com/f9TN0Gh.png"
            alt="eatmi"
            className="w-8 h-8 object-contain"
            loading="lazy"
          />
        </div>
        <div className="leading-tight">
          <div className="font-extrabold tracking-tight text-lg">
            eatmi<span className="text-brand-yellow">.pl</span>
          </div>
          <div className="text-[11px] text-gray-500 font-bold uppercase tracking-wide">Administrator</div>
        </div>
      </div>
    );

    const Pill = ({ children }) => (
      <span className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/80 border border-gray-200 shadow-soft text-xs font-extrabold whitespace-nowrap">
        {children}
      </span>
    );

    const Skeleton = ({ className="" }) => (
      <div className={`animate-pulse bg-gray-200/70 rounded-xl ${className}`} />
    );

    const Icon = ({ name, className="" }) => (
      <i data-lucide={name} className={className}></i>
    );

    const PaymentPill = ({ order }) => {
      const p = resolvePayment(order);
      const kind = p.kind;
      const cls =
        kind === "offline_cash" ? "bg-amber-100 text-amber-900 border-amber-200" :
        kind === "offline_card" ? "bg-violet-100 text-violet-900 border-violet-200" :
        "bg-sky-100 text-sky-900 border-sky-200";

      return (
        <span
          className={`inline-flex items-center gap-2 text-[10px] sm:text-[11px] font-black uppercase tracking-[0.14em] px-2.5 py-1 rounded-full border ${cls}`}
          title={p.label}
        >
          <Icon name="banknote" className="w-3 h-3 opacity-60" />
          {p.badge}
        </span>
      );
    };

    /* =======================
       New Order ALERT
       ======================= */
    const useBeep = () => {
      const audioRef = useRef({ ctx: null, master: null, timer: null, running: false });

      const ensure = async () => {
        const st = audioRef.current;
        if (st.ctx && st.ctx.state === "suspended") {
          try { await st.ctx.resume(); } catch {}
        }
        if (!st.ctx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          st.ctx = new Ctx();
          st.master = st.ctx.createGain();
          st.master.gain.value = 0.9;
          st.master.connect(st.ctx.destination);
        }
      };

      const start = async () => {
        const st = audioRef.current;
        if (st.running) return;
        await ensure();
        if (!st.ctx || !st.master) return;
        st.running = true;

        const tick = () => {
          const s = audioRef.current;
          if (!s.running || !s.ctx || !s.master) return;
          const osc = s.ctx.createOscillator();
          const g = s.ctx.createGain();
          osc.type = "square";
          osc.frequency.value = 1400;
          const now = s.ctx.currentTime;
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.9, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
          osc.connect(g);
          g.connect(s.master);
          osc.start(now);
          osc.stop(now + 0.10);
        };
        tick();
        st.timer = setInterval(tick, 180);
      };

      const stop = () => {
        const st = audioRef.current;
        st.running = false;
        if (st.timer) clearInterval(st.timer);
        st.timer = null;
      };

      useEffect(() => () => stop(), []);
      return { start, stop, ensure };
    };

    const NewOrderOverlay = ({ open, orderPreview, onAcknowledge }) => {
      const [flash, setFlash] = useState(false);
      const flashRef = useRef(null);
      const { start, stop, ensure } = useBeep();

      // FIX: Aggressive icon refresh when overlay is open/flashing
      useEffect(() => {
        if(open) {
             setTimeout(refreshIcons, 0);
             setTimeout(refreshIcons, 50); // Double check for laggy rendering
        }
      }, [open, flash]);

      useEffect(() => {
        if (!open) {
          setFlash(false);
          if (flashRef.current) clearInterval(flashRef.current);
          flashRef.current = null;
          stop();
          return;
        }
        setFlash(false);
        if (flashRef.current) clearInterval(flashRef.current);
        flashRef.current = setInterval(() => setFlash(f => !f), 500); // Slower flash to save performance
        start();
        return () => {
          if (flashRef.current) clearInterval(flashRef.current);
          flashRef.current = null;
          stop();
        };
      }, [open]);

      if (!open) return null;

      const bgClass = flash ? "flash-yellow" : "flash-white";
      const id = orderPreview?.extOrderId || "—";
      const name = orderPreview?.customer?.imieNazwisko || "—";
      const totalPLN = getOrderTotalPLN(orderPreview);
      const pay = resolvePayment(orderPreview);

      return (
        <div className={`ios-fixed z-[999] ${bgClass}`}>
          <div className="absolute inset-0"></div>
          <div className="relative h-full w-full flex items-center justify-center px-4 py-6">
            <div className="w-full max-w-2xl bg-white/95 border border-black/10 shadow-kiosk rounded-3xl p-6 md:p-8 backdrop-blur-xl">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <div className="text-xs uppercase tracking-[0.18em] font-black text-gray-700">NOWE ZAMÓWIENIE</div>
                  <div className="text-2xl md:text-4xl font-black mt-2 leading-tight">Wpadło zamówienie!</div>
                  <div className="text-sm text-gray-700 mt-3 font-medium">Musisz zatwierdzić (kliknij OK), aby przejść dalej.</div>
                  <div className="mt-4 flex items-center gap-2 flex-wrap">
                    <span className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Płatność:</span>
                    <span className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-gray-200 shadow-soft text-xs font-black">{pay.label}</span>
                  </div>
                </div>
                <div className="w-14 h-14 rounded-3xl bg-brand-yellow/30 border border-black/10 grid place-items-center shrink-0">
                  <Icon name="bell-ring" className="w-8 h-8 text-gray-900" />
                </div>
              </div>

              <div className="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
                  <div className="text-[10px] uppercase tracking-[0.16em] text-gray-500 font-black">ID</div>
                  <div className="mt-1 font-mono text-sm break-all">{String(id).slice(-8)}</div>
                </div>
                <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
                  <div className="text-[10px] uppercase tracking-[0.16em] text-gray-500 font-black">Klient</div>
                  <div className="mt-1 font-extrabold text-gray-900 truncate">{name}</div>
                </div>
                <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
                  <div className="text-[10px] uppercase tracking-[0.16em] text-gray-500 font-black">Kwota</div>
                  <div className="mt-1 text-2xl font-black">{currency(totalPLN)}</div>
                </div>
              </div>

              <div className="mt-8">
                <button
                  type="button"
                  onClick={async () => { await ensure(); onAcknowledge?.(); }}
                  className="w-full inline-flex items-center justify-center gap-3 bg-gray-900 text-white font-black rounded-2xl px-8 py-5 shadow-glass hover:ring-4 hover:ring-black/10 active:scale-[0.98] transition text-xl"
                >
                  <Icon name="check" className="w-6 h-6" /> OK, PRZYJMUJĘ
                </button>
                <div className="mt-4 text-center text-xs text-gray-500">
                  Kliknięcie OK zatrzyma alarm dźwiękowy i odświeży listę.
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
       Login
       ======================= */
    const Key = ({ label, onClick, variant="default" }) => {
      const base = "w-full h-16 sm:h-14 rounded-2xl border shadow-soft font-extrabold text-xl active:scale-[0.95] transition touch-manipulation";
      const styles =
        variant === "primary" ? "bg-brand-yellow text-gray-900 border-black/5" :
        variant === "ghost" ? "bg-white text-gray-800 border-gray-200" :
        "bg-white text-gray-900 border-gray-200";
      return <button type="button" onClick={onClick} className={`${base} ${styles}`}>{label}</button>;
    };

    const PinDots = ({ value, max=4 }) => {
      const filled = value.length;
      return (
        <div className="flex items-center justify-center gap-3">
          {Array.from({ length: max }).map((_, i) => (
            <div key={i} className={`w-4 h-4 rounded-full border-2 transition-all ${i < filled ? "bg-gray-900 border-gray-900 scale-110" : "bg-transparent border-gray-300"}`} />
          ))}
        </div>
      );
    };

    const Login = ({ onAuth }) => {
      const [pin, setPin] = useState("");
      const [loading, setLoading] = useState(false);
      const toast = useToast();

      useEffect(() => {
        const onKeyDown = (e) => {
          const k = e.key;
          if (/^\d$/.test(k)) setPin((p) => (p.length < 4 ? p + k : p));
          if (k === "Backspace") setPin((p) => p.slice(0, -1));
          if (k === "Escape") setPin("");
          if (k === "Enter" && pin.length === 4) submit(pin);
        };
        window.addEventListener("keydown", onKeyDown);
        return () => window.removeEventListener("keydown", onKeyDown);
      }, [pin]);

      const addDigit = (d) => setPin((p) => (p.length < 4 ? p + d : p));
      const back = () => setPin((p) => p.slice(0, -1));
      const clear = () => setPin("");

      const submit = async (currentPin) => {
        const v = (currentPin ?? pin).trim();
        if (v.length !== 4) return;
        setLoading(true);
        try {
          const r = await fetch(API.login, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pin: v }),
          });
          const data = await safeJson(r);
          if (!r.ok || !data.token) {
            toast.show("error", "Logowanie", data.error || "Nieprawidłowy kod.");
            setPin("");
            setLoading(false);
            return;
          }
          toast.show("ok", "Logowanie", "Zalogowano.");
          onAuth(data.token);
        } catch (e) {
          console.log(e);
          toast.show("error", "Logowanie", "Błąd połączenia z serwerem.");
          setPin("");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center px-4 py-8">
          <div className="w-full max-w-md">
            <div className="bg-white/90 border border-white/60 shadow-glass rounded-3xl p-6 md:p-8 backdrop-blur-md">
              <div className="flex items-center justify-between gap-3 mb-6">
                <Logo />
                <Pill>
                  <span className="text-[10px] uppercase tracking-[0.16em] text-gray-500">PIN</span>
                </Pill>
              </div>
              <div className="text-center py-4">
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Dostęp do panelu</div>
                <div className="text-3xl font-black mt-2">Wpisz kod</div>
                <div className="mt-8 mb-4"><PinDots value={pin} /></div>
              </div>
              <div className="grid grid-cols-3 gap-3 md:gap-4">
                {["1","2","3","4","5","6","7","8","9"].map((d) => (
                  <Key key={d} label={d} onClick={() => addDigit(d)} />
                ))}
                <Key label="C" variant="ghost" onClick={clear} />
                <Key label="0" onClick={() => addDigit("0")} />
                <Key label="⌫" variant="ghost" onClick={back} />
              </div>
              <button
                type="button"
                onClick={() => submit()}
                disabled={loading || pin.length !== 4}
                className="mt-6 w-full bg-gray-900 text-white font-extrabold rounded-2xl px-5 py-4 shadow-glass hover:ring-4 hover:ring-brand-yellow/35 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed transition text-lg"
              >
                {loading ? "Weryfikacja..." : "Zaloguj się"}
              </button>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
       Layout
       ======================= */
    const NavItem = ({ active, icon, label, onClick, badge }) => (
      <button
        type="button"
        onClick={onClick}
        className={`w-full flex items-center justify-between gap-3 px-4 py-3 rounded-2xl border transition text-left active:scale-[0.98] touch-manipulation ${
          active ? "bg-brand-yellow/20 border-brand-yellow/30 ring-1 ring-brand-yellow/30" : "bg-white border-gray-200 hover:ring-2 hover:ring-brand-yellow/20"
        }`}
      >
        <div className="flex items-center gap-3 min-w-0">
          <span className={`w-10 h-10 rounded-2xl grid place-items-center border shrink-0 ${active ? "bg-brand-yellow/25 border-brand-yellow/30" : "bg-gray-50 border-gray-200"}`}>
            <Icon name={icon} className="w-5 h-5" />
          </span>
          <div className="min-w-0">
            <div className="font-extrabold text-sm text-gray-900 leading-tight">{label}</div>
            <div className="text-[10px] text-gray-500 truncate font-medium">{active ? "Aktywne" : "Przejdź"}</div>
          </div>
        </div>
        {typeof badge === "number" && badge > 0 && (
          <span className="shrink-0 text-[10px] font-black px-2 py-1 rounded-full bg-gray-900 text-white shadow-sm">{badge > 99 ? "99+" : badge}</span>
        )}
      </button>
    );

    const Topbar = ({ title, subtitle, onLogout }) => (
      <div className="sticky top-0 z-40">
        <div className="mx-auto w-full">
          <div className="liquid border-b border-white/60">
            <div className="px-4 md:px-6 py-3 md:py-4 flex items-center justify-between gap-3">
              <div className="min-w-0">
                <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold">Panel</div>
                <div className="text-xl md:text-2xl font-extrabold leading-tight truncate">{title}</div>
                {subtitle && <div className="hidden sm:block text-xs text-gray-600 mt-0.5">{subtitle}</div>}
              </div>
              <button
                type="button"
                onClick={onLogout}
                className="shrink-0 inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-3 py-2 md:px-4 md:py-3 shadow-soft active:scale-95 transition font-extrabold text-xs md:text-sm"
              >
                <Icon name="log-out" className="w-4 h-4" /> <span className="hidden xs:inline">Wyloguj</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    );

    const Card = ({ title, value, icon, hint, loading }) => (
      <div className="bg-white border border-gray-200 rounded-3xl p-5 shadow-soft hover:shadow-md transition">
        <div className="flex items-start justify-between gap-3">
          <div className="min-w-0">
            <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold">{title}</div>
            <div className="mt-1 md:mt-2 text-2xl md:text-3xl font-black tracking-tight text-gray-900">{loading ? <Skeleton className="h-9 w-32" /> : value}</div>
            {hint && <div className="text-[11px] md:text-xs text-gray-500 mt-1">{hint}</div>}
          </div>
          <div className="w-10 h-10 md:w-11 md:h-11 rounded-2xl bg-brand-yellow/20 border border-brand-yellow/30 grid place-items-center shrink-0">
            <Icon name={icon} className="w-5 h-5 md:w-6 md:h-6" />
          </div>
        </div>
      </div>
    );

    /* =======================
       Dashboard
       ======================= */
    const Dashboard = ({ token, refreshSignal }) => {
      const toast = useToast();
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({ ordersTotal: 0, ordersToday: 0, revenueTotal: 0 });

      const load = async (opts={}) => {
        const { silent=false } = opts;
        if(!silent) setLoading(true);
        try {
          const r = await fetch(API.stats, { headers: { ...authHeader(token) } });
          const data = await safeJson(r);
          if (!r.ok) {
            if(!silent) toast.show("error", "Dashboard", data.error || "Błąd pobierania danych.");
            if(!silent) setLoading(false);
            return;
          }
          const revenuePLN = toPLNFromMaybeGrosze(data.revenueTotal || 0, "revenueTotal");
          setStats({
            ordersTotal: Number(data.ordersTotal || 0),
            ordersToday: Number(data.ordersToday || 0),
            revenueTotal: Number(revenuePLN || 0),
          });
        } catch (e) {
          console.log(e);
          if(!silent) toast.show("error", "Dashboard", "Błąd połączenia.");
        } finally {
          if(!silent) setLoading(false);
        }
      };

      useEffect(() => { load(); }, []);
      useEffect(() => { if(refreshSignal) load({silent: true}); }, [refreshSignal]);
      useEffect(() => { refreshIcons(); });

      return (
        <div className="p-4 md:p-6 pb-24">
          <div className="flex items-center justify-between gap-3 mb-5">
            <div className="text-xs md:text-sm text-gray-600">Szybki podgląd dnia.</div>
            <button
              type="button"
              onClick={() => load({silent:false})}
              className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-3 py-2 md:px-4 md:py-3 shadow-soft active:scale-95 transition font-extrabold text-xs md:text-sm"
            >
              <Icon name="refresh-cw" className="w-3 h-3 md:w-4 md:h-4" /> Odśwież
            </button>
          </div>
          <div className="grid gap-4 grid-cols-1 md:grid-cols-3">
            <Card title="Zamówienia łącznie" value={stats.ordersTotal.toLocaleString("pl-PL")} icon="shopping-bag" loading={loading} hint="Suma zamówień (all time)." />
            <Card title="Zamówienia dziś" value={stats.ordersToday.toLocaleString("pl-PL")} icon="calendar" loading={loading} hint="Licznik zerowany o północy." />
            <Card title="Zarobek" value={currency(stats.revenueTotal)} icon="wallet" loading={loading} hint="Szacunkowy przychód." />
          </div>
        </div>
      );
    };

    /* =======================
       Orders & Details
       ======================= */
    const StatusPill = ({ status }) => {
      const s = String(status || "").toLowerCase();
      const cls =
        s.includes("paid") || s.includes("completed") || s.includes("opłac") || s.includes("zrealiz") ? "bg-emerald-100 text-emerald-800 border-emerald-200" :
        s.includes("pending") || s.includes("oczek") || s.includes("w przygotowaniu") ? "bg-amber-100 text-amber-800 border-amber-200" :
        s.includes("cancel") || s.includes("anul") ? "bg-red-100 text-red-800 border-red-200" :
        s.includes("w drodze") ? "bg-brand-yellow/20 text-yellow-900 border-brand-yellow/30" :
        "bg-gray-100 text-gray-800 border-gray-200";

      let iconName = "circle-dashed";
      if (s.includes("paid") || s.includes("completed") || s.includes("opłac") || s.includes("zrealiz")) iconName = "check-circle-2";
      else if (s.includes("pending") || s.includes("oczek") || s.includes("przygotowaniu")) iconName = "clock-3";
      else if (s.includes("cancel") || s.includes("anul")) iconName = "x-circle";
      else if (s.includes("w drodze")) iconName = "bike";

      return (
        <span className={`inline-flex items-center gap-1.5 text-[10px] sm:text-[11px] font-black uppercase tracking-[0.14em] px-2.5 py-1 rounded-full border ${cls}`}>
          <Icon name={iconName} className="w-3.5 h-3.5" />
          {status || "—"}
        </span>
      );
    };

    const Drawer = ({ open, onClose, title, children }) => {
      useEffect(() => {
        const onKey = (e) => { if (open && e.key === "Escape") onClose?.(); };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [open, onClose]);
      
      useEffect(() => { refreshIcons(); }, [open]);

      if (!open) return null;

      return (
        <div className="fixed inset-0 z-[160] flex justify-end">
          <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={onClose} aria-hidden="true"></div>
          <div className="relative w-full lg:max-w-2xl h-full bg-white border-l border-gray-200 shadow-kiosk flex flex-col animate-slideInRight">
            <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-3 shrink-0 bg-white z-10 safe-top-padding">
              <div className="min-w-0">
                <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold">Szczegóły</div>
                <div className="text-lg font-extrabold truncate leading-tight">{title}</div>
              </div>
              <button
                type="button"
                onClick={onClose}
                className="w-10 h-10 rounded-2xl border border-gray-200 bg-white shadow-soft grid place-items-center active:scale-90 transition"
                aria-label="Zamknij"
              >
                <Icon name="x" className="w-5 h-5" />
              </button>
            </div>
            <div className="flex-1 overflow-y-auto drawer-scroll p-4 md:p-6">
              {children}
            </div>
          </div>
        </div>
      );
    };

    const KV = ({ k, v, mono=false }) => (
      <div className="flex items-start justify-between gap-4 border-b border-gray-100 py-3 last:border-0">
        <div className="text-[11px] uppercase tracking-widest text-gray-500 font-extrabold shrink-0 mt-0.5">{k}</div>
        <div className={`text-sm text-gray-900 text-right ${mono ? "font-mono" : "font-semibold"} break-words max-w-[70%]`}>{v ?? "—"}</div>
      </div>
    );

    const OrderDetails = ({ order, token, onRefresh }) => {
      const toast = useToast();
      const [updating, setUpdating] = useState(false);

      const c = order.customer || {};
      const cart = Array.isArray(order.cart) ? order.cart : (Array.isArray(order.items) ? order.items : []);
      const totalPLN = getOrderTotalPLN(order);
      const pay = resolvePayment(order);

      // Delivery logic
      const productsValue = cart.reduce((sum, item) => {
         return sum + (getItemUnitPricePLN(item) * (item.qty || 1));
      }, 0);
      
      let deliveryCost = 0;
      if (productsValue < 50) deliveryCost = 10;
      else if (productsValue < 80) deliveryCost = 5;
      else deliveryCost = 0;

      const changeStatus = async (newStatus) => {
        if(updating) return;
        setUpdating(true);
        try {
          const r = await fetch(`/api/admin/orders/${order.extOrderId}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', ...authHeader(token) },
            body: JSON.stringify({ status: newStatus })
          });
          const d = await safeJson(r);
          if(!r.ok) throw new Error(d.error || "Błąd");
          toast.show("ok", "Status", `Zmieniono na: ${newStatus}`);
          onRefresh?.();
        } catch (e) {
          console.error(e);
          toast.show("error", "Błąd", "Nie udało się zmienić statusu");
        } finally {
          setUpdating(false);
        }
      };

      return (
        <div className="space-y-5 pb-10">
          
          {/* AKCJE - ZMIANA STATUSU */}
          <div className="bg-white border border-gray-200 rounded-3xl p-5 shadow-sm">
            <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold mb-3">Akcje (Zmień status)</div>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
               <button onClick={() => changeStatus("W przygotowaniu")} disabled={updating} className="flex flex-col items-center justify-center p-3 rounded-xl border border-blue-200 bg-blue-50 text-blue-800 hover:bg-blue-100 transition font-bold text-xs gap-1">
                 <Icon name="chef-hat" className="w-5 h-5"/> W kuchni
               </button>
               <button onClick={() => changeStatus("W drodze")} disabled={updating} className="flex flex-col items-center justify-center p-3 rounded-xl border border-brand-yellow/30 bg-brand-yellow/10 text-yellow-900 hover:bg-brand-yellow/20 transition font-bold text-xs gap-1">
                 <Icon name="bike" className="w-5 h-5"/> W drodze
               </button>
               <button onClick={() => changeStatus("Zrealizowane")} disabled={updating} className="flex flex-col items-center justify-center p-3 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 transition font-bold text-xs gap-1">
                 <Icon name="check-circle" className="w-5 h-5"/> Zrealizowane
               </button>
               <button onClick={() => changeStatus("Anulowane")} disabled={updating} className="flex flex-col items-center justify-center p-3 rounded-xl border border-red-200 bg-red-50 text-red-800 hover:bg-red-100 transition font-bold text-xs gap-1">
                 <Icon name="x-circle" className="w-5 h-5"/> Anulowane
               </button>
            </div>
          </div>

          <div className="bg-gray-50 border border-gray-200 rounded-3xl p-5">
            <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
              <div>
                <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold">Status & Płatność</div>
                <div className="mt-2 flex flex-wrap items-center gap-2">
                  <StatusPill status={order.status || order.paymentStatus || order.payuStatus || "—"} />
                  <PaymentPill order={order} />
                </div>
                <div className="mt-2 text-sm text-gray-600 font-medium">{pay.label}</div>
              </div>
              <div className="text-left sm:text-right border-t sm:border-0 border-gray-200 pt-3 sm:pt-0 mt-2 sm:mt-0">
                <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold">Razem</div>
                <div className="mt-1 text-3xl font-black">{currency(totalPLN)}</div>
              </div>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl p-5 shadow-sm">
            <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold mb-2">Dane klienta</div>
            <div className="flex flex-col">
              <KV k="Imię i nazwisko" v={c.imieNazwisko || c.name} />
              <KV k="Telefon" v={c.telefon || c.phone} mono />
              <KV k="Email" v={c.email} />
              <KV k="Adres" v={`${c.miasto || '-'}, ${c.ulica || '-'} ${c.nrBud || ''}${c.lokal ? '/'+c.lokal : ''}`} />
              <KV k="Kod pocztowy" v={c.kod} mono />
              <KV k="Uwagi" v={c.uwagi} />
              <KV k="Faktura" v={c.faktura ? "Tak" : "Nie"} />
              {c.faktura && <><KV k="NIP" v={c.nip} mono /><KV k="Firma" v={c.firma} /></>}
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl p-5 shadow-sm">
            <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold mb-3">Koszyk ({cart.length})</div>
            <div className="space-y-3">
              {cart.length === 0 ? <div className="text-sm text-gray-600 italic">Pusty koszyk w danych.</div> : cart.map((it, i) => {
                const qty = Number(it.qty || it.quantity || 1) || 1;
                const name = resolveProductName(it);
                const unitPricePLN = getItemUnitPricePLN(it);
                const linePLN = unitPricePLN * qty;
                
                return (
                  <div key={i} className="border border-gray-200 rounded-2xl p-3 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                    <div className="min-w-0">
                      <div className="font-bold text-gray-900 text-sm leading-tight">{name}</div>
                      
                      {Array.isArray(it.addons) && it.addons.length > 0 && (
                        <div className="mt-1 flex flex-wrap gap-1">
                          {it.addons.map((a, idx) => (
                            <span key={idx} className="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-brand-yellow/20 text-yellow-900 border border-brand-yellow/30">
                              + {a.label}
                            </span>
                          ))}
                        </div>
                      )}

                      <div className="text-xs text-gray-500 mt-1 font-mono"><span className="font-black text-gray-900">{qty}x</span> @ {currency(unitPricePLN)}</div>
                    </div>
                    <div className="font-black text-sm text-right shrink-0 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                      {currency(linePLN)}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* DELIVERY SUMMARY */}
            <div className="mt-4 pt-3 border-t border-gray-100 space-y-1 text-sm text-gray-700">
                <div className="flex justify-between">
                    <span>Wartość produktów:</span>
                    <span className="font-bold">{currency(productsValue)}</span>
                </div>
                <div className="flex justify-between">
                    <span>Dostawa:</span>
                    <span className="font-bold">{currency(deliveryCost)}</span>
                </div>
                <div className="flex justify-between text-lg border-t border-gray-200 pt-2 mt-2">
                    <span className="font-extrabold text-gray-900">RAZEM:</span>
                    <span className="font-black text-gray-900">{currency(totalPLN)}</span>
                </div>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl p-5 shadow-sm">
            <div className="text-[10px] uppercase tracking-[0.18em] text-gray-500 font-extrabold mb-2">Techniczne</div>
            <div className="flex flex-col">
               <KV k="ID (DB)" v={order.orderId || order.id || order._id} mono />
               <KV k="Ext ID" v={order.extOrderId} mono />
               <KV k="PayU ID" v={order.payuOrderId || order.payu?.orderId} mono />
               <KV k="Utworzono" v={fmtDate(pickCreatedAt(order))} mono />
            </div>
          </div>
        </div>
      );
    };

    const OrderCard = ({ o, idx, onSelect }) => {
      const id = pickOrderId(o, idx);
      const name = o.customer?.imieNazwisko || o.customer?.name || o.name || "—";
      const total = currency(getOrderTotalPLN(o));
      const status = o.status || o.paymentStatus || "—";
      const date = fmtDate(pickCreatedAt(o));

      return (
        <div 
          onClick={() => onSelect(o)}
          className="bg-white border border-gray-200 rounded-3xl p-4 shadow-soft active:scale-[0.98] transition cursor-pointer relative overflow-hidden group"
        >
          <div className="flex justify-between items-start gap-3">
            <div className="min-w-0">
              <div className="text-[10px] text-gray-500 font-mono mb-1">#{String(id).slice(-6)}</div>
              <div className="font-extrabold text-gray-900 truncate text-lg">{name}</div>
              <div className="text-xs text-gray-500 mt-0.5 font-medium">{date}</div>
            </div>
            <div className="text-right shrink-0">
              <div className="font-black text-xl">{total}</div>
            </div>
          </div>
          <div className="mt-4 flex items-center gap-2 flex-wrap">
            <StatusPill status={status} />
            <PaymentPill order={o} />
          </div>
          <div className="absolute right-4 bottom-4 opacity-0 group-hover:opacity-100 transition-opacity hidden lg:block text-brand-yellow">
             <Icon name="chevron-right" className="w-6 h-6" />
          </div>
        </div>
      );
    };

    const STORAGE_LAST_ACK = "eatmi-admin-last-ack-v2";

    const Orders = ({ token, onNewOrderDetected, setOrdersCount, refreshSignal }) => {
      const toast = useToast();
      const [loading, setLoading] = useState(true);
      const [orders, setOrders] = useState([]);
      const [query, setQuery] = useState("");
      const [selected, setSelected] = useState(null);

      const load = async (opts = {}) => {
        const { silent = false } = opts;
        if (!silent) setLoading(true);

        try {
          const url = new URL(API.orders, window.location.origin);
          if (query.trim()) url.searchParams.set("query", query.trim());

          const r = await fetch(url.toString(), { headers: { ...authHeader(token) } });
          const data = await safeJson(r);
          if (!r.ok) {
            if (!silent) toast.show("error", "Zamówienia", data.error || "Błąd pobierania.");
            if (!silent) setLoading(false);
            return;
          }

          const list = Array.isArray(data.orders) ? data.orders : [];
          setOrders(list);
          setOrdersCount?.(list.length);

          // Update selected if open (for live updates)
          if(selected) {
              const updatedSelected = list.find(o => o.extOrderId === selected.extOrderId);
              if(updatedSelected) setSelected(updatedSelected);
          }

          const newest = list[0];
          if (newest) {
            const newestKey = String(newest.extOrderId);
            const rawAck = localStorage.getItem(STORAGE_LAST_ACK) || "";
            if (newestKey !== rawAck) {
              onNewOrderDetected?.(newest);
            }
          }
        } catch (e) {
          console.log(e);
          if (!silent) toast.show("error", "Zamówienia", "Błąd sieci.");
        } finally {
          if (!silent) setLoading(false);
        }
      };

      useEffect(() => { load(); }, []);
      useEffect(() => { if(refreshSignal) load({ silent: true }); }, [refreshSignal]); // Reload when signal changes
      useEffect(() => { refreshIcons(); });

      const rows = useMemo(() => {
        const q = query.trim().toLowerCase();
        if (!q) return orders;
        return orders.filter((o) => JSON.stringify(o).toLowerCase().includes(q));
      }, [orders, query]);

      return (
        <div className="p-4 md:p-6 pb-24">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
            <div className="flex-1">
              <div className="relative">
                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                  <Icon name="search" className="w-5 h-5" />
                </span>
                <input
                  className="input-focus w-full lg:max-w-md bg-white border border-gray-200 rounded-2xl pl-11 pr-4 py-3 md:py-3.5 shadow-soft text-base"
                  placeholder="Szukaj (nazwisko, telefon, ID)..."
                  value={query}
                  onChange={(e)=>setQuery(e.target.value)}
                />
              </div>
            </div>
            <button
              type="button"
              onClick={() => load({ silent: false })}
              className="inline-flex items-center justify-center gap-2 bg-white border border-gray-200 rounded-2xl px-5 py-3 md:py-3.5 shadow-soft active:scale-95 transition font-extrabold text-sm"
            >
              <Icon name="refresh-cw" className="w-4 h-4" /> Odśwież
            </button>
          </div>

          {/* Mobile / Tablet List */}
          <div className="lg:hidden space-y-3">
            {loading ? (
              [1,2,3].map(i => <Skeleton key={i} className="h-40 w-full" />)
            ) : rows.length === 0 ? (
              <div className="bg-white/50 border border-gray-200 rounded-3xl p-8 text-center text-gray-500">Brak wyników.</div>
            ) : (
              rows.map((o, idx) => <OrderCard key={pickOrderId(o, idx)} o={o} idx={idx} onSelect={setSelected} />)
            )}
          </div>

          {/* Desktop Table */}
          <div className="hidden lg:block bg-white border border-gray-200 rounded-3xl shadow-soft overflow-hidden">
            <div className="overflow-x-auto">
               <table className="w-full text-left border-collapse">
                 <thead className="bg-gray-50/80 border-b border-gray-200">
                   <tr>
                     <th className="px-6 py-4 text-[10px] uppercase tracking-widest text-gray-500 font-extrabold">ID</th>
                     <th className="px-6 py-4 text-[10px] uppercase tracking-widest text-gray-500 font-extrabold">Data</th>
                     <th className="px-6 py-4 text-[10px] uppercase tracking-widest text-gray-500 font-extrabold">Klient</th>
                     <th className="px-6 py-4 text-[10px] uppercase tracking-widest text-gray-500 font-extrabold">Status</th>
                     <th className="px-6 py-4 text-[10px] uppercase tracking-widest text-gray-500 font-extrabold text-right">Kwota</th>
                     <th className="px-6 py-4"></th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-100">
                   {loading ? (
                     [1,2,3,4].map(i => <tr key={i}><td colSpan="6" className="p-6"><Skeleton className="h-8 w-full" /></td></tr>)
                   ) : rows.length === 0 ? (
                     <tr><td colSpan="6" className="p-10 text-center text-gray-500">Brak zamówień.</td></tr>
                   ) : (
                     rows.map((o, idx) => (
                       <tr key={pickOrderId(o, idx)} className="hover:bg-gray-50 transition group cursor-pointer" onClick={()=>setSelected(o)}>
                         <td className="px-6 py-4 font-mono text-xs text-gray-600">{String(pickOrderId(o, idx)).slice(-8)}</td>
                         <td className="px-6 py-4 text-sm font-medium text-gray-700">{fmtDate(pickCreatedAt(o))}</td>
                         <td className="px-6 py-4">
                           <div className="font-bold text-gray-900">{o.customer?.imieNazwisko || o.name || "—"}</div>
                           <div className="text-xs text-gray-500">{o.customer?.telefon}</div>
                         </td>
                         <td className="px-6 py-4"><div className="flex gap-2"><StatusPill status={o.status} /><PaymentPill order={o} /></div></td>
                         <td className="px-6 py-4 text-right font-black text-gray-900">{currency(getOrderTotalPLN(o))}</td>
                         <td className="px-6 py-4 text-right">
                           <button className="w-8 h-8 rounded-xl border border-gray-200 bg-white grid place-items-center shadow-sm hover:border-brand-yellow">
                             <Icon name="eye" className="w-4 h-4 text-gray-500" />
                           </button>
                         </td>
                       </tr>
                     ))
                   )}
                 </tbody>
               </table>
            </div>
          </div>

          <Drawer open={!!selected} onClose={() => setSelected(null)} title={selected ? "Zamówienie" : ""}>
             {selected && <OrderDetails order={selected} token={token} onRefresh={() => load({ silent: true })} />}
          </Drawer>
        </div>
      );
    };

    /* =======================
       Push
       ======================= */
    const Push = ({ token }) => {
      const toast = useToast();
      const [title, setTitle] = useState("");
      const [body, setBody] = useState("");
      const [loading, setLoading] = useState(false);

      useEffect(() => { refreshIcons(); });

      const send = async () => {
        if (!body.trim()) return toast.show("error", "Push", "Brak treści.");
        setLoading(true);
        try {
          const r = await fetch(API.push, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...authHeader(token) },
            body: JSON.stringify({ title: title.trim(), body: body.trim() }),
          });
          if (!r.ok) throw new Error();
          setTitle(""); setBody("");
          toast.show("ok", "Push", "Wysłano powiadomienie.");
        } catch {
          toast.show("error", "Push", "Błąd wysyłania.");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="p-4 md:p-6 pb-24 max-w-2xl mx-auto lg:mx-0">
          <div className="bg-white border border-gray-200 rounded-3xl shadow-soft p-5 md:p-8">
            <div className="flex items-center gap-4 mb-6">
              <div className="w-12 h-12 rounded-2xl bg-brand-yellow/20 border border-brand-yellow/30 grid place-items-center text-brand-dark shrink-0">
                <Icon name="megaphone" className="w-6 h-6" />
              </div>
              <div>
                <h2 className="text-lg font-extrabold">Nowe powiadomienie</h2>
                <p className="text-xs text-gray-500">Wyślij wiadomość do wszystkich użytkowników aplikacji.</p>
              </div>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-xs uppercase font-extrabold text-gray-500 mb-2 ml-1">Tytuł</label>
                <input
                  className="input-focus w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3.5 text-base"
                  placeholder="np. Promocja na lunch"
                  value={title}
                  onChange={e => setTitle(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-xs uppercase font-extrabold text-gray-500 mb-2 ml-1">Treść</label>
                <textarea
                  className="input-focus w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3.5 min-h-[140px] text-base"
                  placeholder="Wpisz tutaj treść powiadomienia..."
                  value={body}
                  onChange={e => setBody(e.target.value)}
                />
              </div>
              <button
                onClick={send}
                disabled={loading}
                className="w-full bg-gray-900 text-white font-extrabold rounded-2xl py-4 shadow-glass hover:bg-gray-800 active:scale-[0.98] transition flex items-center justify-center gap-2"
              >
                {loading ? "Wysyłanie..." : <><Icon name="send" className="w-4 h-4" /> Wyślij teraz</>}
              </button>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
       Staff
       ======================= */
    const Staff = ({ token }) => {
      const toast = useToast();
      const [list, setList] = useState([]);
      const [loading, setLoading] = useState(true);
      const [name, setName] = useState("");
      const [pin, setPin] = useState("");
      const [saving, setSaving] = useState(false);

      const load = async () => {
        setLoading(true);
        try {
          const r = await fetch(API.staff, { headers: { ...authHeader(token) } });
          const d = await safeJson(r);
          if (r.ok) setList(Array.isArray(d.staff) ? d.staff : (Array.isArray(d) ? d : []));
        } catch {} finally { setLoading(false); }
      };

      useEffect(() => { load(); }, []);
      useEffect(() => { refreshIcons(); });

      const add = async () => {
        if (!name.trim() || pin.length !== 4) return toast.show("error", "Obsługa", "Błędne dane.");
        setSaving(true);
        try {
          const r = await fetch(API.staff, {
            method: "POST",
            headers: {"Content-Type":"application/json", ...authHeader(token)},
            body: JSON.stringify({ name: name.trim(), pin }),
          });
          if (!r.ok) throw new Error();
          toast.show("ok", "Obsługa", "Dodano.");
          setName(""); setPin(""); load();
        } catch {
          toast.show("error", "Obsługa", "Błąd.");
        } finally { setSaving(false); }
      };

      const remove = async (id) => {
        if(!confirm("Usunąć dostęp?")) return;
        try {
          await fetch(`${API.staff}/${id}`, { method: "DELETE", headers: {...authHeader(token)} });
          load();
        } catch {}
      };

      return (
        <div className="p-4 md:p-6 pb-24 grid lg:grid-cols-3 gap-6 items-start">
          <div className="bg-white border border-gray-200 rounded-3xl shadow-soft p-5 md:p-6 lg:col-span-1">
            <div className="flex items-center gap-3 mb-5">
              <div className="w-10 h-10 rounded-xl bg-gray-100 grid place-items-center"><Icon name="user-plus" className="w-5 h-5 text-gray-700" /></div>
              <div className="font-extrabold text-lg">Dodaj</div>
            </div>
            <div className="space-y-4">
              <input className="input-focus w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3.5 text-base" placeholder="Imię i nazwisko" value={name} onChange={e=>setName(e.target.value)} />
              <input className="input-focus w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3.5 text-base font-mono tracking-widest" placeholder="PIN (4 cyfry)" maxLength={4} inputMode="numeric" value={pin} onChange={e=>setPin(e.target.value.replace(/\D/g,'').slice(0,4))} />
              <button onClick={add} disabled={saving} className="w-full bg-gray-900 text-white font-extrabold rounded-2xl py-3.5 shadow-glass hover:bg-gray-800 active:scale-[0.98] transition">
                {saving ? "..." : "Dodaj pracownika"}
              </button>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl shadow-soft p-5 md:p-6 lg:col-span-2">
            <div className="flex items-center justify-between mb-5">
              <div className="font-extrabold text-lg">Lista pracowników</div>
              <button onClick={load} className="p-2 bg-gray-50 rounded-xl hover:bg-gray-100"><Icon name="refresh-cw" className="w-4 h-4" /></button>
            </div>
            <div className="space-y-3">
              {loading ? <Skeleton className="h-16 w-full" /> : list.length===0 ? <div className="text-gray-500 text-sm">Pusto.</div> : list.map(p => (
                <div key={p.id||p._id} className="flex items-center justify-between p-4 border border-gray-200 rounded-2xl">
                  <div>
                    <div className="font-bold text-gray-900">{p.name}</div>
                    <div className="text-xs text-gray-400 font-mono mt-0.5">ID: {String(p.id||p._id).slice(-4)}</div>
                  </div>
                  <button onClick={() => remove(p.id||p._id)} className="text-red-500 p-2 hover:bg-red-50 rounded-xl transition"><Icon name="trash-2" className="w-4 h-4" /></button>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    /* =======================
       App Shell & Logic
       ======================= */
    const STORAGE_KEY = "eatmi-admin-token";

    const AppShell = ({ token, onLogout }) => {
      const toast = useToast();
      const [tab, setTab] = useState("dashboard");
      const [ordersCount, setOrdersCount] = useState(0);
      const [alertOpen, setAlertOpen] = useState(false);
      const [alertOrder, setAlertOrder] = useState(null);
      const [refreshSignal, setRefreshSignal] = useState(0); // For auto-refresh
      const latestOrderRef = useRef(null);

      // Title Logic
      const titleData = {
        dashboard: { t: "Dashboard", s: "Przegląd statystyk" },
        orders: { t: "Zamówienia", s: "Zarządzanie zamówieniami" },
        push: { t: "Powiadomienia", s: "Wysyłka PUSH" },
        staff: { t: "Obsługa", s: "Zarządzanie personelem" }
      };
      const curT = titleData[tab] || {t:"Panel",s:""};

      // Alert Logic
      const acknowledge = () => {
        const o = alertOrder;
        if (o) {
          const key = String(o.extOrderId);
          localStorage.setItem(STORAGE_LAST_ACK, key);
        }
        setAlertOpen(false);
        setAlertOrder(null);
        setTab("orders");
        // Trigger list refresh
        setRefreshSignal(Date.now());
        toast.show("ok", "Powiadomienie", "Potwierdzono.");
      };

      // SSE Live Updates - UPDATED for reliable auto-refresh
      useEffect(() => {
        if (!token) return;
        let es = null;

        try {
          const url = `${API.events}?token=${token}`;
          es = new EventSource(url);
          
          es.onopen = () => console.log("SSE Connected");
          
          es.addEventListener("new_order", (e) => {
              const d = JSON.parse(e.data);
              
              // 1. Force refresh of data
              setRefreshSignal(Date.now());
              
              // 2. Force Alert Open (Directly set state, no ref logic here needed to force UI)
              const miniOrder = {
                  extOrderId: d.extOrderId,
                  totalPLN: d.totalPLN,
                  customer: { imieNazwisko: d.customer },
                  status: d.status,
                  paymentMethod: d.paymentMethod,
                  createdAt: new Date().toISOString() 
              };
              
              setAlertOrder(miniOrder);
              setAlertOpen(true);
          });

          es.addEventListener("order_update", (e) => {
              setRefreshSignal(Date.now());
          });
          
          es.onerror = () => { console.log("SSE Error"); es.close(); };

        } catch (err) {
          console.error("SSE Setup Error", err);
        }
        
        return () => {
          if (es) es.close();
        };
      }, [token]);

      useEffect(() => { refreshIcons(); }, [tab, ordersCount]);

      return (
        <div className="min-h-screen pb-[env(safe-area-inset-bottom)]">
          <NewOrderOverlay open={alertOpen} orderPreview={alertOrder} onAcknowledge={acknowledge} />
          <div className={alertOpen ? "no-interact blur-sm" : ""}>
            
            {/* Desktop Sidebar */}
            <aside className="hidden lg:block fixed inset-y-0 left-0 w-[var(--sidebar-w)] p-4 z-50">
               <div className="bg-white/90 border border-white/60 shadow-glass rounded-[2rem] h-full flex flex-col p-5 backdrop-blur-xl">
                 <Logo />
                 <div className="mt-8 space-y-2 flex-1">
                   <NavItem active={tab==="dashboard"} icon="layout-dashboard" label="Dashboard" onClick={()=>setTab("dashboard")} />
                   <NavItem active={tab==="orders"} icon="clipboard-list" label="Zamówienia" badge={ordersCount} onClick={()=>setTab("orders")} />
                   <NavItem active={tab==="push"} icon="megaphone" label="Powiadomienia" onClick={()=>setTab("push")} />
                   <NavItem active={tab==="staff"} icon="users" label="Obsługa" onClick={()=>setTab("staff")} />
                 </div>
                 <div className="pt-4 border-t border-gray-100">
                    <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-red-50 text-red-600 transition font-bold text-sm">
                       <Icon name="log-out" className="w-5 h-5" /> Wyloguj się
                    </button>
                 </div>
               </div>
            </aside>

            {/* Mobile/Tablet Tab Bar (Top) */}
            <div className="lg:hidden px-4 pt-4 pb-0">
               <div className="bg-white/90 border border-white/60 shadow-soft rounded-2xl p-2 grid grid-cols-4 gap-1 backdrop-blur-md">
                 {[
                   { id: "dashboard", icon: "layout-dashboard", label: "Start" },
                   { id: "orders", icon: "clipboard-list", label: "Zam.", badge: ordersCount },
                   { id: "push", icon: "megaphone", label: "Push" },
                   { id: "staff", icon: "users", label: "Ekipa" }
                 ].map(item => (
                   <button
                     key={item.id}
                     onClick={()=>setTab(item.id)}
                     className={`flex flex-col items-center justify-center py-2 rounded-xl transition active:scale-95 ${tab===item.id ? "bg-brand-yellow/20 text-gray-900" : "text-gray-500 hover:bg-gray-50"}`}
                   >
                     <div className="relative">
                       <Icon name={item.icon} className={`w-6 h-6 ${tab===item.id?"stroke-[2.5px]":""}`} />
                       {item.badge > 0 && <span className="absolute -top-1 -right-2 w-4 h-4 bg-red-500 text-white text-[9px] font-bold rounded-full grid place-items-center border-2 border-white">{item.badge}</span>}
                     </div>
                     <span className="text-[10px] font-bold mt-1 uppercase tracking-wide">{item.label}</span>
                   </button>
                 ))}
               </div>
            </div>

            <main className="lg:ml-[var(--sidebar-w)] transition-all duration-300">
              <Topbar title={curT.t} subtitle={curT.s} onLogout={onLogout} />
              <div className="animate-fadeIn">
                {tab === "dashboard" && <Dashboard token={token} refreshSignal={refreshSignal} />}
                {tab === "orders" && (
                    <Orders 
                        token={token} 
                        setOrdersCount={setOrdersCount} 
                        onNewOrderDetected={(o) => { /* handled by SSE now but kept for legacy checks */ }} 
                        refreshSignal={refreshSignal}
                    />
                )}
                {tab === "push" && <Push token={token} />}
                {tab === "staff" && <Staff token={token} />}
              </div>
            </main>

          </div>
        </div>
      );
    };

    const Root = () => {
      const [token, setToken] = useState(() => localStorage.getItem(STORAGE_KEY) || "");
      const onAuth = (t) => { setToken(t); localStorage.setItem(STORAGE_KEY, t); };
      const logout = () => { setToken(""); localStorage.removeItem(STORAGE_KEY); };
      return token ? <AppShell token={token} onLogout={logout} /> : <Login onAuth={onAuth} />;
    };

    const container = document.getElementById("root");
    const root = ReactDOM.createRoot(container);
    root.render(
      <ToastProvider>
        <Root />
      </ToastProvider>
    );
  </script>
</body>
</html>
