<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#FFC107" />
  <title>eatmi.pl — Panel Administratora</title>
  <meta name="description" content="Panel administratora eatmi.pl" />
    <link rel="icon" type="image/png" href="favicon.png">

  <!-- Tailwind config MUST be before tailwindcdn script -->
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              yellow: '#FFC107',
              dark: '#111827',
              light: '#F9FAFB'
            },
            kiosk: {
              bg: '#0B0F1A',
              card: '#0F1629',
              card2: '#111B34',
              green: '#22C55E',
              red: '#EF4444',
              blue: '#3B82F6',
              violet: '#8B5CF6',
              orange: '#F59E0B',
              gray: '#94A3B8'
            }
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.08)',
            glass: '0 8px 25px rgba(0,0,0,.12)',
            kiosk: '0 14px 50px rgba(0,0,0,.35)'
          },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
      --sidebar-w: 280px;
    }
    html, body { height: 100%; }
    body { overscroll-behavior-y: none; }

    .liquid { background: rgba(255,255,255,.75); backdrop-filter: blur(12px); }
    .input-focus { outline: none; }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(255,193,7,.35); border-color: rgba(255,193,7,.75); }
    .toast-enter { animation: toastIn .18s ease-out; }
    @keyframes toastIn { from { transform: translateY(8px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

    /* Subtle background */
    .bg-soft {
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(255,193,7,.22), transparent 55%),
        radial-gradient(700px 450px at 95% 20%, rgba(59,130,246,.14), transparent 55%),
        radial-gradient(600px 400px at 30% 110%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(#fff, #f7f8fb);
    }

    /* Drawer scroll */
    .drawer-scroll { max-height: calc(100vh - 140px); overflow: auto; }

    /* New order full-screen overlay flashing */
    .flash-yellow { background: #FFC107; }
    .flash-white { background: #ffffff; }
    .no-interact { pointer-events: none; user-select: none; }
  </style>

  <!-- React 18 + ReactDOM 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel for inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-soft text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* =========================================================
      WYMAGANE ENDPOINTY (backend / Twój server.js po aktualizacji):

      Auth:
        POST /api/admin/login  { pin: "1234" } -> { token }

      Stats:
        GET  /api/admin/stats

      Orders:
        GET  /api/admin/orders?query=&from=&to=
        -> { orders: [...] } (posortowane: najnowsze na górze zalecane)

      Realtime (zalecane, ale kod ma fallback do pollingu):
        GET /api/admin/events  (SSE)
        -> event: message
           data: {"type":"new_order","orderId":"...","createdAt":"..."}  (JSON)
      ========================================================= */

    const API = {
      login: "/api/admin/login",
      stats: "/api/admin/stats",
      orders: "/api/admin/orders",
      push: "/api/admin/push",
      staff: "/api/admin/staff",
      events: "/api/admin/events", // SSE (opcjonalne, ale wspierane w tym admin.html)
    };

    /* =======================
      Utils
    ======================= */
    const currency = (n) => {
      const num = Number(n || 0);
      return new Intl.NumberFormat('pl-PL', { style:'currency', currency:'PLN' }).format(num);
    };

    const safeJson = async (r) => {
      try { return await r.json(); } catch { return {}; }
    };

    const authHeader = (token) => token ? { Authorization: `Bearer ${token}` } : {};

    const pickOrderId = (o, idx=0) => o?.id || o?.orderId || o?.extOrderId || o?._id || `row-${idx}`;
    const pickCreatedAt = (o) => o?.createdAt || o?.created_at || o?.date || o?.timestamp || o?.orderDate || null;

    /* =======================
      Mapowanie productId -> pełna nazwa (EDYTUJ wg swoich ID)
    ======================= */
    const PRODUCT_NAME_MAP = {
      "bs-small-1": "Box śniadaniowy mały nr 1",
      "bs-small-2": "Box śniadaniowy mały nr 2",
      "bs-small-3": "Box śniadaniowy mały nr 3",

      "bs-medium-1": "Box śniadaniowy średni nr 1",
      "bs-medium-2": "Box śniadaniowy średni nr 2",
      "bs-medium-3": "Box śniadaniowy średni nr 3",

      "bs-big-1": "Box śniadaniowy duży nr 1",
      "bs-big-2": "Box śniadaniowy duży nr 2",
      "bs-big-3": "Box śniadaniowy duży nr 3",

      // dodatki (przykład)
      "extra-granola": "Granola",
      "extra-lemoniada": "Lemoniada",
      "extra-deser": "Deser",
    };

    const resolveProductName = (it) => {
      const fromBackend = it?.name || it?.productName || it?.title;
      if (fromBackend && String(fromBackend).trim()) return String(fromBackend);

      const pid = it?.productId || it?.sku || "";
      if (pid && PRODUCT_NAME_MAP[pid]) return PRODUCT_NAME_MAP[pid];

      return pid || "Pozycja";
    };

    /* =======================
      Toast
    ======================= */
    const ToastContext = React.createContext();
    const useToast = () => React.useContext(ToastContext);

    const ToastProvider = ({ children }) => {
      const [toast, setToast] = useState(null);
      const tRef = useRef(null);

      const show = (type, title, msg) => {
        setToast({ type, title, msg });
        if (tRef.current) clearTimeout(tRef.current);
        tRef.current = setTimeout(() => setToast(null), 2600);
      };

      const close = () => {
        if (tRef.current) clearTimeout(tRef.current);
        setToast(null);
      };

      return (
        <ToastContext.Provider value={{ show }}>
          {children}
          {toast && (
            <div className="fixed bottom-[calc(18px+var(--safe-b))] left-1/2 -translate-x-1/2 z-[200] pointer-events-none">
              <div className="pointer-events-auto toast-enter bg-white/95 border border-gray-200 shadow-glass rounded-2xl px-4 py-3 min-w-[280px] max-w-[92vw] flex items-start gap-3">
                <div className={`w-9 h-9 rounded-full grid place-items-center text-lg ${
                  toast.type === "ok" ? "bg-emerald-100 text-emerald-700" :
                  toast.type === "error" ? "bg-red-100 text-red-700" :
                  "bg-gray-100 text-gray-700"
                }`}>
                  {toast.type === "ok" ? "✓" : toast.type === "error" ? "!" : "i"}
                </div>
                <div className="flex-1">
                  <div className="text-[10px] font-extrabold uppercase tracking-[0.14em] text-gray-500">
                    {toast.title || (toast.type === "ok" ? "Sukces" : toast.type === "error" ? "Błąd" : "Info")}
                  </div>
                  <div className="text-sm text-gray-900 mt-0.5">{toast.msg}</div>
                </div>
                <button
                  type="button"
                  onClick={close}
                  className="ml-2 text-gray-400 hover:text-gray-700 text-xl leading-none"
                  aria-label="Zamknij"
                >
                  ×
                </button>
              </div>
            </div>
          )}
        </ToastContext.Provider>
      );
    };

    /* =======================
      Components: Shell
    ======================= */
    const Logo = () => (
      <div className="flex items-center gap-3">
        <div className="w-10 h-10 rounded-2xl bg-white border border-gray-200 shadow-soft grid place-items-center overflow-hidden">
          <img
            src="https://i.imgur.com/f9TN0Gh.png"
            alt="eatmi"
            className="w-8 h-8 object-contain"
            loading="lazy"
          />
        </div>
        <div className="leading-tight">
          <div className="font-extrabold tracking-tight">
            eatmi<span className="text-brand-yellow">.pl</span>
          </div>
          <div className="text-xs text-gray-500 font-semibold">Panel administratora</div>
        </div>
      </div>
    );

    const Pill = ({ children }) => (
      <span className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/80 border border-gray-200 shadow-soft text-xs font-extrabold">
        {children}
      </span>
    );

    const Skeleton = ({ className="" }) => (
      <div className={`animate-pulse bg-gray-200/70 rounded-xl ${className}`} />
    );

    const Icon = ({ name, className="" }) => (
      <i data-lucide={name} className={className}></i>
    );

    /* =======================
      New Order ALERT (full-screen, flashing + loud beep)
    ======================= */
    const useBeep = () => {
      const audioRef = useRef({ ctx: null, master: null, timer: null, running: false });

      const ensure = async () => {
        const st = audioRef.current;
        if (st.ctx && st.ctx.state === "suspended") {
          try { await st.ctx.resume(); } catch {}
        }
        if (!st.ctx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          st.ctx = new Ctx();
          st.master = st.ctx.createGain();
          st.master.gain.value = 0.9;
          st.master.connect(st.ctx.destination);
        }
      };

      const start = async () => {
        const st = audioRef.current;
        if (st.running) return;
        await ensure();
        if (!st.ctx || !st.master) return;

        st.running = true;

        const tick = () => {
          const s = audioRef.current;
          if (!s.running || !s.ctx || !s.master) return;

          const osc = s.ctx.createOscillator();
          const g = s.ctx.createGain();

          osc.type = "square";
          osc.frequency.value = 1400;

          const now = s.ctx.currentTime;
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.9, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);

          osc.connect(g);
          g.connect(s.master);

          osc.start(now);
          osc.stop(now + 0.10);
        };

        tick();
        st.timer = setInterval(tick, 180);
      };

      const stop = () => {
        const st = audioRef.current;
        st.running = false;
        if (st.timer) clearInterval(st.timer);
        st.timer = null;
      };

      useEffect(() => () => stop(), []);
      return { start, stop, ensure };
    };

    const NewOrderOverlay = ({ open, orderPreview, onAcknowledge }) => {
      const [flash, setFlash] = useState(false);
      const flashRef = useRef(null);
      const { start, stop, ensure } = useBeep();

      useEffect(() => {
        if (!open) {
          setFlash(false);
          if (flashRef.current) clearInterval(flashRef.current);
          flashRef.current = null;
          stop();
          return;
        }

        setFlash(false);
        if (flashRef.current) clearInterval(flashRef.current);
        flashRef.current = setInterval(() => setFlash(f => !f), 100);

        start();

        return () => {
          if (flashRef.current) clearInterval(flashRef.current);
          flashRef.current = null;
          stop();
        };
      }, [open]);

      useEffect(() => { window.lucide?.createIcons?.(); }, [open, flash]);

      if (!open) return null;

      const bgClass = flash ? "flash-yellow" : "flash-white";

      const id = orderPreview?.id || orderPreview?.orderId || orderPreview?.extOrderId || orderPreview?._id || "—";
      const name = orderPreview?.customer?.imieNazwisko || orderPreview?.customer?.name || orderPreview?.name || "—";
      const phone = orderPreview?.customer?.telefon || orderPreview?.customer?.phone || orderPreview?.telefon || "—";
      const total = orderPreview?.total ?? orderPreview?.totalAmount ?? orderPreview?.amount ?? 0;

      return (
        <div className={`fixed inset-0 z-[999] ${bgClass}`}>
          <div className="absolute inset-0"></div>

          <div className="relative h-full w-full flex items-center justify-center px-4">
            <div className="w-full max-w-2xl bg-white/90 border border-black/10 shadow-kiosk rounded-3xl p-6 md:p-8">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <div className="text-xs uppercase tracking-[0.18em] font-black text-gray-700">
                    NOWE ZAMÓWIENIE
                  </div>
                  <div className="text-3xl md:text-4xl font-black mt-2 leading-tight">
                    Wpadło nowe zamówienie!
                  </div>
                  <div className="text-sm text-gray-700 mt-3">
                    Dopóki nie klikniesz <span className="font-black">OK</span>, nie da się zamknąć tego ekranu.
                  </div>
                </div>

                <div className="w-14 h-14 rounded-3xl bg-brand-yellow/30 border border-black/10 grid place-items-center shrink-0">
                  <Icon name="bell-ring" className="w-8 h-8 text-gray-900" />
                </div>
              </div>

              <div className="mt-6 grid md:grid-cols-3 gap-3">
                <div className="bg-white border border-gray-200 rounded-2xl p-4">
                  <div className="text-[10px] uppercase tracking-[0.16em] text-gray-500 font-black">ID</div>
                  <div className="mt-2 font-mono text-sm break-all">{String(id)}</div>
                </div>
                <div className="bg-white border border-gray-200 rounded-2xl p-4">
                  <div className="text-[10px] uppercase tracking-[0.16em] text-gray-500 font-black">Klient</div>
                  <div className="mt-2 font-extrabold text-gray-900">{name}</div>
                  <div className="mt-1 text-xs text-gray-600 font-mono">{phone}</div>
                </div>
                <div className="bg-white border border-gray-200 rounded-2xl p-4">
                  <div className="text-[10px] uppercase tracking-[0.16em] text-gray-500 font-black">Kwota</div>
                  <div className="mt-2 text-2xl font-black">{currency(total)}</div>
                </div>
              </div>

              <div className="mt-6 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
                <button
                  type="button"
                  onClick={async () => { await ensure(); onAcknowledge?.(); }}
                  className="w-full md:w-auto inline-flex items-center justify-center gap-2 bg-gray-900 text-white font-black rounded-2xl px-7 py-5 shadow-glass hover:ring-2 hover:ring-black/20 transition text-lg"
                >
                  <Icon name="check" className="w-6 h-6" />
                  OK
                </button>

                <div className="text-xs text-gray-700">
                  Tip: po kliknięciu OK przejdź do zakładki <span className="font-black">Zamówienia</span>.
                </div>
              </div>

              <div className="mt-5 text-[11px] text-gray-600">
                Uwaga: jeśli przeglądarka blokuje auto-dźwięk, kliknij OK — i tak musisz potwierdzić.
              </div>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
      Login: ekranowa klawiatura + PIN 4 cyfry
    ======================= */
    const Key = ({ label, onClick, variant="default" }) => {
      const base =
        "w-full h-14 rounded-2xl border shadow-soft font-extrabold text-lg active:scale-[0.99] transition";
      const styles =
        variant === "primary"
          ? "bg-brand-yellow text-gray-900 border-black/5 hover:ring-2 hover:ring-brand-yellow/40"
          : variant === "ghost"
          ? "bg-white text-gray-800 border-gray-200 hover:ring-2 hover:ring-brand-yellow/25"
          : "bg-white text-gray-900 border-gray-200 hover:ring-2 hover:ring-brand-yellow/25";
      return (
        <button type="button" onClick={onClick} className={`${base} ${styles}`}>
          {label}
        </button>
      );
    };

    const PinDots = ({ value, max=4 }) => {
      const filled = value.length;
      return (
        <div className="flex items-center justify-center gap-2">
          {Array.from({ length: max }).map((_, i) => (
            <div
              key={i}
              className={`w-3.5 h-3.5 rounded-full border ${
                i < filled ? "bg-gray-900 border-gray-900" : "bg-white border-gray-300"
              }`}
            />
          ))}
        </div>
      );
    };

    const Login = ({ onAuth }) => {
      const [pin, setPin] = useState("");
      const [loading, setLoading] = useState(false);
      const toast = useToast();

      useEffect(() => {
        const onKeyDown = (e) => {
          const k = e.key;
          if (/^\d$/.test(k)) setPin((p) => (p.length < 4 ? p + k : p));
          if (k === "Backspace") setPin((p) => p.slice(0, -1));
          if (k === "Escape") setPin("");
          if (k === "Enter" && pin.length === 4) submit(pin);
        };
        window.addEventListener("keydown", onKeyDown);
        return () => window.removeEventListener("keydown", onKeyDown);
      }, [pin]);

      const addDigit = (d) => setPin((p) => (p.length < 4 ? p + d : p));
      const back = () => setPin((p) => p.slice(0, -1));
      const clear = () => setPin("");

      const submit = async (currentPin) => {
        const v = (currentPin ?? pin).trim();
        if (v.length !== 4) return;

        setLoading(true);
        try {
          const r = await fetch(API.login, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pin: v }),
          });
          const data = await safeJson(r);

          if (!r.ok || !data.token) {
            toast.show("error", "Logowanie", data.error || "Nieprawidłowy kod.");
            setPin("");
            setLoading(false);
            return;
          }

          toast.show("ok", "Logowanie", "Zalogowano.");
          onAuth(data.token);
        } catch (e) {
          console.log(e);
          toast.show("error", "Logowanie", "Błąd połączenia z serwerem.");
          setPin("");
        } finally {
          setLoading(false);
        }
      };

      const disabled = loading;

      return (
        <div className="min-h-screen flex items-center justify-center px-4 py-10">
          <div className="w-full max-w-md">
            <div className="bg-white/85 border border-white/60 shadow-glass rounded-3xl p-6 md:p-7">
              <div className="flex items-center justify-between gap-3">
                <Logo />
                <Pill>
                  <span className="text-[10px] uppercase tracking-[0.16em] text-gray-500">PIN</span>
                  <span className="font-black text-gray-900">4 cyfry</span>
                </Pill>
              </div>

              <div className="mt-6 text-center">
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">
                  Dostęp do panelu
                </div>
                <div className="text-2xl font-extrabold mt-1">Wpisz kod</div>
                <div className="text-sm text-gray-600 mt-2">
                  Użyj klawiatury ekranowej lub klawiatury fizycznej.
                </div>

                <div className="mt-5">
                  <PinDots value={pin} />
                </div>
              </div>

              <div className="mt-6 grid grid-cols-3 gap-3">
                {["1","2","3","4","5","6","7","8","9"].map((d) => (
                  <Key key={d} label={d} onClick={() => addDigit(d)} />
                ))}
                <Key label="Wyczyść" variant="ghost" onClick={clear} />
                <Key label="0" onClick={() => addDigit("0")} />
                <Key label="⌫" variant="ghost" onClick={back} />
              </div>

              <button
                type="button"
                onClick={() => submit()}
                disabled={disabled || pin.length !== 4}
                className="mt-4 w-full bg-gray-900 text-white font-extrabold rounded-2xl px-5 py-4 shadow-glass hover:ring-2 hover:ring-brand-yellow/35 disabled:opacity-60 disabled:cursor-not-allowed transition"
              >
                {loading ? "Logowanie..." : "Zaloguj"}
              </button>

              <div className="mt-4 text-xs text-gray-500 text-center">
                Jeśli kod jest błędny — wpisz ponownie.
              </div>
            </div>

            <div className="mt-4 text-center text-xs text-gray-500">
              <span className="inline-flex items-center gap-2">
                <Icon name="shield" className="w-4 h-4" /> Bezpieczny dostęp
              </span>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
      Layout: Sidebar + Topbar
    ======================= */
    const NavItem = ({ active, icon, label, onClick, badge }) => (
      <button
        type="button"
        onClick={onClick}
        className={`w-full flex items-center justify-between gap-3 px-4 py-3 rounded-2xl border transition text-left ${
          active
            ? "bg-brand-yellow/20 border-brand-yellow/30 ring-1 ring-brand-yellow/30"
            : "bg-white border-gray-200 hover:ring-2 hover:ring-brand-yellow/20"
        }`}
      >
        <div className="flex items-center gap-3 min-w-0">
          <span className={`w-10 h-10 rounded-2xl grid place-items-center border ${
            active ? "bg-brand-yellow/25 border-brand-yellow/30" : "bg-gray-50 border-gray-200"
          }`}>
            <Icon name={icon} className="w-5 h-5" />
          </span>
          <div className="min-w-0">
            <div className="font-extrabold text-sm text-gray-900">{label}</div>
            <div className="text-xs text-gray-500 truncate">
              {active ? "Aktywne" : "Otwórz"}
            </div>
          </div>
        </div>
        {typeof badge === "number" && badge > 0 && (
          <span className="shrink-0 text-[11px] font-black px-2.5 py-1 rounded-full bg-gray-900 text-white">
            {badge > 99 ? "99+" : badge}
          </span>
        )}
      </button>
    );

    const Topbar = ({ title, subtitle, onLogout }) => (
      <div className="sticky top-0 z-40">
        <div className="mx-auto w-full">
          <div className="liquid border-b border-white/60">
            <div className="px-4 md:px-6 py-4 flex items-center justify-between gap-4">
              <div className="min-w-0">
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">
                  Panel
                </div>
                <div className="text-xl md:text-2xl font-extrabold mt-1 truncate">{title}</div>
                {subtitle && <div className="text-sm text-gray-600 mt-1">{subtitle}</div>}
              </div>

              <button
                type="button"
                onClick={onLogout}
                className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft hover:ring-2 hover:ring-brand-yellow/25 transition font-extrabold text-sm"
              >
                <Icon name="log-out" className="w-4 h-4" />
                Wyloguj
              </button>
            </div>
          </div>
        </div>
      </div>
    );

    const Card = ({ title, value, icon, hint, loading }) => (
      <div className="bg-white border border-gray-200 rounded-3xl p-5 shadow-soft hover:shadow-md transition">
        <div className="flex items-start justify-between gap-3">
          <div className="min-w-0">
            <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">
              {title}
            </div>
            <div className="mt-2 text-3xl font-black tracking-tight">
              {loading ? <Skeleton className="h-9 w-40" /> : value}
            </div>
            {hint && <div className="text-xs text-gray-500 mt-2">{hint}</div>}
          </div>
          <div className="w-11 h-11 rounded-2xl bg-brand-yellow/20 border border-brand-yellow/30 grid place-items-center">
            <Icon name={icon} className="w-6 h-6" />
          </div>
        </div>
      </div>
    );

    /* =======================
      Pages: Dashboard
    ======================= */
    const Dashboard = ({ token }) => {
      const toast = useToast();
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({ ordersTotal: 0, ordersToday: 0, revenueTotal: 0 });

      const load = async () => {
        setLoading(true);
        try {
          const r = await fetch(API.stats, { headers: { ...authHeader(token) } });
          const data = await safeJson(r);
          if (!r.ok) {
            toast.show("error", "Dashboard", data.error || "Nie udało się pobrać statystyk.");
            setLoading(false);
            return;
          }
          setStats({
            ordersTotal: Number(data.ordersTotal || 0),
            ordersToday: Number(data.ordersToday || 0),
            revenueTotal: Number(data.revenueTotal || 0),
          });
        } catch (e) {
          console.log(e);
          toast.show("error", "Dashboard", "Błąd połączenia z serwerem.");
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => { load(); }, []);
      useEffect(() => { window.lucide?.createIcons?.(); });

      return (
        <div className="p-4 md:p-6">
          <div className="flex items-center justify-between gap-3">
            <div className="text-sm text-gray-600">
              Podgląd kluczowych danych — bez zbędnych elementów.
            </div>
            <button
              type="button"
              onClick={load}
              className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft hover:ring-2 hover:ring-brand-yellow/25 transition font-extrabold text-sm"
            >
              <Icon name="refresh-cw" className="w-4 h-4" />
              Odśwież
            </button>
          </div>

          <div className="mt-5 grid gap-4 md:grid-cols-3">
            <Card
              title="Zamówienia łącznie"
              value={stats.ordersTotal.toLocaleString("pl-PL")}
              icon="shopping-bag"
              loading={loading}
              hint="Suma wszystkich zamówień w systemie."
            />
            <Card
              title="Zamówienia dziś"
              value={stats.ordersToday.toLocaleString("pl-PL")}
              icon="calendar"
              loading={loading}
              hint="Zamówienia z bieżącego dnia (wg backendu)."
            />
            <Card
              title="Zarobek"
              value={currency(stats.revenueTotal)}
              icon="wallet"
              loading={loading}
              hint="Łączny przychód (wg backendu)."
            />
          </div>
        </div>
      );
    };

    /* =======================
      Pages: Orders
    ======================= */
    const StatusPill = ({ status }) => {
      const s = String(status || "").toLowerCase();
      const cls =
        s.includes("paid") || s.includes("completed") || s.includes("opłac") ? "bg-emerald-100 text-emerald-800 border-emerald-200" :
        s.includes("pending") || s.includes("oczek") ? "bg-amber-100 text-amber-800 border-amber-200" :
        s.includes("cancel") || s.includes("anul") ? "bg-red-100 text-red-800 border-red-200" :
        "bg-gray-100 text-gray-800 border-gray-200";
      return (
        <span className={`inline-flex items-center gap-2 text-[11px] font-black uppercase tracking-[0.14em] px-2.5 py-1 rounded-full border ${cls}`}>
          <span className="w-1.5 h-1.5 rounded-full bg-current opacity-70"></span>
          {status || "—"}
        </span>
      );
    };

    const Drawer = ({ open, onClose, title, children }) => {
      useEffect(() => {
        const onKey = (e) => { if (open && e.key === "Escape") onClose?.(); };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [open, onClose]);

      useEffect(() => { window.lucide?.createIcons?.(); }, [open]);

      if (!open) return null;

      return (
        <div className="fixed inset-0 z-[160]">
          <div className="absolute inset-0 bg-black/40" onClick={onClose} aria-hidden="true"></div>
          <div className="absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-white border-l border-gray-200 shadow-kiosk">
            <div className="p-4 border-b border-gray-200 flex items-center justify-between gap-3">
              <div className="min-w-0">
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Szczegóły</div>
                <div className="text-lg font-extrabold truncate">{title}</div>
              </div>
              <button
                type="button"
                onClick={onClose}
                className="w-11 h-11 rounded-2xl border border-gray-200 bg-white shadow-soft grid place-items-center hover:ring-2 hover:ring-brand-yellow/25"
                aria-label="Zamknij"
              >
                <Icon name="x" className="w-5 h-5" />
              </button>
            </div>
            <div className="p-4 drawer-scroll">
              {children}
            </div>
          </div>
        </div>
      );
    };

    const KV = ({ k, v, mono=false }) => (
      <div className="flex items-start justify-between gap-4 border-b border-gray-100 py-3">
        <div className="text-xs uppercase tracking-widest text-gray-500 font-extrabold">{k}</div>
        <div className={`text-sm text-gray-900 text-right ${mono ? "font-mono" : "font-semibold"} break-words max-w-[65%]`}>
          {v ?? "—"}
        </div>
      </div>
    );

    const OrderDetails = ({ order }) => {
      const c = order.customer || {};
      const cart = Array.isArray(order.cart) ? order.cart : (Array.isArray(order.items) ? order.items : []);
      const total = order.total ?? order.totalAmount ?? order.amount ?? 0;

      return (
        <div className="space-y-6">
          <div className="bg-gray-50 border border-gray-200 rounded-3xl p-4">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Status</div>
                <div className="mt-2">
                  <StatusPill status={order.status || order.paymentStatus || order.payuStatus || "—"} />
                </div>
              </div>
              <div className="text-right">
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Kwota</div>
                <div className="mt-2 text-2xl font-black">{currency(total)}</div>
              </div>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl p-4">
            <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Dane klienta</div>
            <div className="mt-2">
              <KV k="Imię i nazwisko" v={c.imieNazwisko || c.name} />
              <KV k="Telefon" v={c.telefon || c.phone} mono />
              <KV k="Email" v={c.email} />
              <KV k="Miasto" v={c.miasto} />
              <KV k="Kod" v={c.kod} mono />
              <KV k="Ulica" v={c.ulica} />
              <KV k="Nr budynku" v={c.nrBud} mono />
              <KV k="Piętro" v={c.pietro} mono />
              <KV k="Nr lokalu" v={c.lokal} mono />
              <KV k="Uwagi" v={c.uwagi} />
              <KV k="Faktura" v={c.faktura ? "Tak" : "Nie"} />
              {c.faktura && (
                <>
                  <KV k="NIP" v={c.nip} mono />
                  <KV k="Firma" v={c.firma} />
                </>
              )}
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl p-4">
            <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Pozycje</div>
            <div className="mt-3 space-y-3">
              {cart.length === 0 ? (
                <div className="text-sm text-gray-600">Brak danych koszyka w obiekcie zamówienia.</div>
              ) : (
                cart.map((it, i) => {
                  const qty = it.qty || it.quantity || 1;
                  const name = resolveProductName(it); /* ✅ ZAMIANA ID NA PEŁNĄ NAZWĘ */
                  const price = it.price ?? it.unitPrice ?? it.unit_amount ?? 0;
                  const line = (Number(price)||0) * (Number(qty)||1);

                  return (
                    <div key={i} className="border border-gray-200 rounded-2xl p-4 hover:ring-2 hover:ring-brand-yellow/15 transition">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="font-extrabold text-gray-900">{name}</div>
                          {/* ❌ USUNIĘTE: productId/sku żeby nie wyświetlać bs-small-3 */}
                          <div className="text-xs text-gray-500 mt-1">
                            <span className="font-black">{qty}×</span> szt.
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="font-black">{currency(line)}</div>
                          <div className="text-xs text-gray-500 mt-1">
                            {currency(price)} / szt.
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-3xl p-4">
            <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Dane techniczne</div>
            <div className="mt-2">
              <KV k="orderId" v={order.orderId || order.id || order._id} mono />
              <KV k="extOrderId" v={order.extOrderId} mono />
              <KV k="payuOrderId" v={order.payuOrderId || order.payu?.orderId} mono />
              <KV k="createdAt" v={order.createdAt || order.created_at || order.date || order.timestamp} mono />
            </div>
          </div>
        </div>
      );
    };

    const STORAGE_LAST_ACK = "eatmi-admin-last-ack"; // { lastSeenKey: string, ts: number }

    const Orders = ({ token, onNewOrderDetected, setOrdersCount }) => {
      const toast = useToast();
      const [loading, setLoading] = useState(true);
      const [orders, setOrders] = useState([]);
      const [query, setQuery] = useState("");
      const [selected, setSelected] = useState(null);

      const load = async (opts = {}) => {
        const { silent = false } = opts;
        if (!silent) setLoading(true);

        try {
          const url = new URL(API.orders, window.location.origin);
          if (query.trim()) url.searchParams.set("query", query.trim());

          const r = await fetch(url.toString(), { headers: { ...authHeader(token) } });
          const data = await safeJson(r);
          if (!r.ok) {
            toast.show("error", "Zamówienia", data.error || "Nie udało się pobrać zamówień.");
            if (!silent) setLoading(false);
            return;
          }

          const list = Array.isArray(data.orders) ? data.orders : [];
          setOrders(list);
          setOrdersCount?.(list.length);

          const newest = list[0];
          if (newest) {
            const newestId = pickOrderId(newest, 0);
            const newestCreated = pickCreatedAt(newest) || "";
            const newestKey = `${newestId}|${newestCreated}`;

            const rawAck = localStorage.getItem(STORAGE_LAST_ACK) || "";
            let ack = null;
            try { ack = rawAck ? JSON.parse(rawAck) : null; } catch { ack = null; }
            const lastSeenKey = ack?.lastSeenKey || "";

            if (newestKey && newestKey !== lastSeenKey) {
              onNewOrderDetected?.(newest);
            }
          }
        } catch (e) {
          console.log(e);
          if (!silent) toast.show("error", "Zamówienia", "Błąd połączenia z serwerem.");
        } finally {
          if (!silent) setLoading(false);
        }
      };

      useEffect(() => { load(); }, []);
      useEffect(() => { window.lucide?.createIcons?.(); });

      const rows = useMemo(() => {
        const q = query.trim().toLowerCase();
        if (!q) return orders;
        return orders.filter((o) => {
          const blob = JSON.stringify(o || {}).toLowerCase();
          return blob.includes(q);
        });
      }, [orders, query]);

      const fmtDate = (iso) => {
        if (!iso) return "—";
        try {
          const d = new Date(iso);
          return d.toLocaleString("pl-PL");
        } catch { return String(iso); }
      };

      const sumOrder = (o) => {
        const total = o?.total ?? o?.totalAmount ?? o?.amount ?? 0;
        return currency(total);
      };

      return (
        <div className="p-4 md:p-6">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
            <div className="flex-1">
              <div className="text-sm text-gray-600">
                Lista zamówień z pełnymi danymi klienta (wg backendu).
              </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
              <div className="relative">
                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                  <Icon name="search" className="w-4 h-4" />
                </span>
                <input
                  className="input-focus w-full sm:w-[320px] bg-white border border-gray-200 rounded-2xl pl-9 pr-4 py-3 shadow-soft"
                  placeholder="Szukaj (ID, email, telefon, produkt...)"
                  value={query}
                  onChange={(e)=>setQuery(e.target.value)}
                />
              </div>

              <button
                type="button"
                onClick={() => load({ silent: false })}
                className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft hover:ring-2 hover:ring-brand-yellow/25 transition font-extrabold text-sm"
              >
                <Icon name="refresh-cw" className="w-4 h-4" />
                Odśwież
              </button>
            </div>
          </div>

          <div className="mt-4 bg-white border border-gray-200 rounded-3xl shadow-soft overflow-hidden">
            <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
              <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">
                Zamówienia
              </div>
              <div className="text-xs text-gray-500 font-semibold">
                {loading ? "Ładowanie..." : `${rows.length} pozycji`}
              </div>
            </div>

            <div className="overflow-auto">
              <table className="min-w-[920px] w-full">
                <thead className="bg-gray-50">
                  <tr className="text-left text-xs uppercase tracking-widest text-gray-500">
                    <th className="px-4 py-3 font-extrabold">ID</th>
                    <th className="px-4 py-3 font-extrabold">Data</th>
                    <th className="px-4 py-3 font-extrabold">Klient</th>
                    <th className="px-4 py-3 font-extrabold">Kontakt</th>
                    <th className="px-4 py-3 font-extrabold">Status</th>
                    <th className="px-4 py-3 font-extrabold text-right">Kwota</th>
                    <th className="px-4 py-3 font-extrabold"></th>
                  </tr>
                </thead>
                <tbody>
                  {loading ? (
                    Array.from({ length: 6 }).map((_, i) => (
                      <tr key={i} className="border-t border-gray-100">
                        <td className="px-4 py-4"><Skeleton className="h-5 w-32" /></td>
                        <td className="px-4 py-4"><Skeleton className="h-5 w-40" /></td>
                        <td className="px-4 py-4"><Skeleton className="h-5 w-44" /></td>
                        <td className="px-4 py-4"><Skeleton className="h-5 w-56" /></td>
                        <td className="px-4 py-4"><Skeleton className="h-6 w-28" /></td>
                        <td className="px-4 py-4 text-right"><Skeleton className="h-5 w-24 ml-auto" /></td>
                        <td className="px-4 py-4"><Skeleton className="h-10 w-28" /></td>
                      </tr>
                    ))
                  ) : rows.length === 0 ? (
                    <tr>
                      <td colSpan="7" className="px-4 py-10 text-center text-gray-600">
                        Brak zamówień do wyświetlenia.
                      </td>
                    </tr>
                  ) : (
                    rows.map((o, idx) => {
                      const id = pickOrderId(o, idx);
                      const name = o.customer?.imieNazwisko || o.customer?.name || o.name || "—";
                      const email = o.customer?.email || o.email || "—";
                      const phone = o.customer?.telefon || o.customer?.phone || o.telefon || "—";
                      const status = o.status || o.paymentStatus || o.payuStatus || "—";
                      const created = pickCreatedAt(o);

                      return (
                        <tr key={id} className="border-t border-gray-100 hover:bg-gray-50/60">
                          <td className="px-4 py-4">
                            <div className="font-mono text-xs text-gray-700">{String(id)}</div>
                          </td>
                          <td className="px-4 py-4 text-sm text-gray-700 whitespace-nowrap">
                            {fmtDate(created)}
                          </td>
                          <td className="px-4 py-4">
                            <div className="font-extrabold text-sm text-gray-900">{name}</div>
                            <div className="text-xs text-gray-500 mt-1">
                              {o.customer?.miasto ? `${o.customer.miasto}` : "—"}
                            </div>
                          </td>
                          <td className="px-4 py-4 text-sm text-gray-700">
                            <div>{email}</div>
                            <div className="text-xs text-gray-500 mt-1">{phone}</div>
                          </td>
                          <td className="px-4 py-4">
                            <StatusPill status={status} />
                          </td>
                          <td className="px-4 py-4 text-right font-extrabold whitespace-nowrap">
                            {sumOrder(o)}
                          </td>
                          <td className="px-4 py-4">
                            <button
                              type="button"
                              onClick={() => setSelected(o)}
                              className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-2.5 shadow-soft hover:ring-2 hover:ring-brand-yellow/25 transition font-extrabold text-sm"
                            >
                              <Icon name="eye" className="w-4 h-4" />
                              Szczegóły
                            </button>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>

          <Drawer
            open={!!selected}
            onClose={() => setSelected(null)}
            title={selected ? `Zamówienie: ${pickOrderId(selected)}` : ""}
          >
            {selected && (
              <OrderDetails order={selected} />
            )}
          </Drawer>
        </div>
      );
    };

    /* =======================
      Pages: Push notifications (zostawione, jeśli masz backend)
    ======================= */
    const Push = ({ token }) => {
      const toast = useToast();
      const [title, setTitle] = useState("");
      const [body, setBody] = useState("");
      const [loading, setLoading] = useState(false);

      useEffect(() => { window.lucide?.createIcons?.(); });

      const send = async () => {
        const msg = body.trim();
        if (!msg) {
          toast.show("error", "Powiadomienia push", "Wpisz treść powiadomienia.");
          return;
        }
        setLoading(true);
        try {
          const r = await fetch(API.push, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...authHeader(token)
            },
            body: JSON.stringify({ title: title.trim() || undefined, body: msg }),
          });
          const data = await safeJson(r);
          if (!r.ok) {
            toast.show("error", "Powiadomienia push", data.error || "Nie udało się wysłać powiadomienia.");
            setLoading(false);
            return;
          }
          setTitle("");
          setBody("");
          toast.show("ok", "Powiadomienia push", "Wysłano do użytkowników.");
        } catch (e) {
          console.log(e);
          toast.show("error", "Powiadomienia push", "Błąd połączenia z serwerem.");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="p-4 md:p-6">
          <div className="bg-white border border-gray-200 rounded-3xl shadow-soft p-5">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Wysyłka push</div>
                <div className="text-xl font-extrabold mt-1">Powiadomienia push</div>
                <div className="text-sm text-gray-600 mt-2">
                  Wpisz treść i wyślij — każdy użytkownik aplikacji otrzyma powiadomienie (wg backendu).
                </div>
              </div>
              <div className="w-11 h-11 rounded-2xl bg-brand-yellow/20 border border-brand-yellow/30 grid place-items-center">
                <Icon name="bell" className="w-6 h-6" />
              </div>
            </div>

            <div className="mt-5 grid gap-4">
              <div>
                <label className="text-xs uppercase tracking-widest text-gray-500 font-extrabold">Tytuł (opcjonalnie)</label>
                <input
                  className="input-focus mt-2 w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft"
                  placeholder="np. eatmi — nowość"
                  value={title}
                  onChange={(e)=>setTitle(e.target.value)}
                />
              </div>
              <div>
                <label className="text-xs uppercase tracking-widest text-gray-500 font-extrabold">Treść</label>
                <textarea
                  className="input-focus mt-2 w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft min-h-[160px]"
                  placeholder="Wpisz wiadomość push..."
                  value={body}
                  onChange={(e)=>setBody(e.target.value)}
                />
              </div>

              <button
                type="button"
                onClick={send}
                disabled={loading}
                className="w-full md:w-auto inline-flex items-center justify-center gap-2 bg-gray-900 text-white font-extrabold rounded-2xl px-5 py-4 shadow-glass hover:ring-2 hover:ring-brand-yellow/35 disabled:opacity-60 disabled:cursor-not-allowed transition"
              >
                <Icon name="send" className="w-5 h-5" />
                {loading ? "Wysyłanie..." : "Wyślij powiadomienie"}
              </button>

              <div className="text-xs text-gray-500">
                Uwaga: backend powinien mieć zaimplementowany mechanizm push (np. Web Push / FCM / APNs).
              </div>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
      Pages: Staff (zostawione, jeśli masz backend)
    ======================= */
    const Staff = ({ token }) => {
      const toast = useToast();
      const [loading, setLoading] = useState(true);
      const [list, setList] = useState([]);
      const [name, setName] = useState("");
      const [pin, setPin] = useState("");
      const [saving, setSaving] = useState(false);

      const load = async () => {
        setLoading(true);
        try {
          const r = await fetch(API.staff, { headers: { ...authHeader(token) } });
          const data = await safeJson(r);
          if (!r.ok) {
            toast.show("error", "Obsługa", data.error || "Nie udało się pobrać listy pracowników.");
            setLoading(false);
            return;
          }
          setList(Array.isArray(data.staff) ? data.staff : (Array.isArray(data) ? data : []));
        } catch (e) {
          console.log(e);
          toast.show("error", "Obsługa", "Błąd połączenia z serwerem.");
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => { load(); }, []);
      useEffect(() => { window.lucide?.createIcons?.(); });

      const add = async () => {
        const n = name.trim();
        const p = pin.trim();
        if (!n) return toast.show("error", "Obsługa", "Wpisz imię i nazwisko.");
        if (!/^\d{4}$/.test(p)) return toast.show("error", "Obsługa", "PIN musi mieć 4 cyfry.");

        setSaving(true);
        try {
          const r = await fetch(API.staff, {
            method: "POST",
            headers: { "Content-Type":"application/json", ...authHeader(token) },
            body: JSON.stringify({ name: n, pin: p }),
          });
          const data = await safeJson(r);
          if (!r.ok) {
            toast.show("error", "Obsługa", data.error || "Nie udało się dodać pracownika.");
            setSaving(false);
            return;
          }
          setName("");
          setPin("");
          toast.show("ok", "Obsługa", "Dodano pracownika.");
          load();
        } catch (e) {
          console.log(e);
          toast.show("error", "Obsługa", "Błąd połączenia z serwerem.");
        } finally {
          setSaving(false);
        }
      };

      const remove = async (id) => {
        if (!id) return;
        try {
          const r = await fetch(`${API.staff}/${encodeURIComponent(id)}`, {
            method: "DELETE",
            headers: { ...authHeader(token) },
          });
          const data = await safeJson(r);
          if (!r.ok) {
            toast.show("error", "Obsługa", data.error || "Nie udało się usunąć pracownika.");
            return;
          }
          toast.show("ok", "Obsługa", "Usunięto pracownika.");
          load();
        } catch (e) {
          console.log(e);
          toast.show("error", "Obsługa", "Błąd połączenia z serwerem.");
        }
      };

      const onlyDigits4 = (v) => (v || "").replace(/[^\d]/g, "").slice(0, 4);

      return (
        <div className="p-4 md:p-6">
          <div className="grid lg:grid-cols-3 gap-5 items-start">
            <div className="lg:col-span-1 bg-white border border-gray-200 rounded-3xl shadow-soft p-5">
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Dostęp</div>
                  <div className="text-xl font-extrabold mt-1">Dodaj pracownika</div>
                  <div className="text-sm text-gray-600 mt-2">
                    Pracownik loguje się do panelu własnym PIN-em (4 cyfry).
                  </div>
                </div>
                <div className="w-11 h-11 rounded-2xl bg-brand-yellow/20 border border-brand-yellow/30 grid place-items-center">
                  <Icon name="user-plus" className="w-6 h-6" />
                </div>
              </div>

              <div className="mt-5 space-y-4">
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500 font-extrabold">Imię i nazwisko</label>
                  <input
                    className="input-focus mt-2 w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft"
                    placeholder="np. Jan Kowalski"
                    value={name}
                    onChange={(e)=>setName(e.target.value)}
                  />
                </div>
                <div>
                  <label className="text-xs uppercase tracking-widest text-gray-500 font-extrabold">PIN (4 cyfry)</label>
                  <input
                    className="input-focus mt-2 w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft font-mono tracking-widest"
                    placeholder="1234"
                    inputMode="numeric"
                    value={pin}
                    onChange={(e)=>setPin(onlyDigits4(e.target.value))}
                  />
                </div>

                <button
                  type="button"
                  onClick={add}
                  disabled={saving}
                  className="w-full inline-flex items-center justify-center gap-2 bg-gray-900 text-white font-extrabold rounded-2xl px-5 py-4 shadow-glass hover:ring-2 hover:ring-brand-yellow/35 disabled:opacity-60 disabled:cursor-not-allowed transition"
                >
                  <Icon name="plus" className="w-5 h-5" />
                  {saving ? "Dodawanie..." : "Dodaj"}
                </button>

                <div className="text-xs text-gray-500">
                  Backend powinien przechowywać pracowników i weryfikować PIN w /api/admin/login.
                </div>
              </div>
            </div>

            <div className="lg:col-span-2 bg-white border border-gray-200 rounded-3xl shadow-soft overflow-hidden">
              <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                <div>
                  <div className="text-xs uppercase tracking-[0.18em] text-gray-500 font-extrabold">Obsługa</div>
                  <div className="text-lg font-extrabold mt-0.5">Lista pracowników</div>
                </div>
                <button
                  type="button"
                  onClick={load}
                  className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft hover:ring-2 hover:ring-brand-yellow/25 transition font-extrabold text-sm"
                >
                  <Icon name="refresh-cw" className="w-4 h-4" />
                  Odśwież
                </button>
              </div>

              <div className="p-4">
                {loading ? (
                  <div className="space-y-3">
                    <Skeleton className="h-16 w-full" />
                    <Skeleton className="h-16 w-full" />
                    <Skeleton className="h-16 w-full" />
                  </div>
                ) : list.length === 0 ? (
                  <div className="text-sm text-gray-600">
                    Brak pracowników. Dodaj pierwszą osobę po lewej stronie.
                  </div>
                ) : (
                  <div className="space-y-3">
                    {list.map((p, i) => {
                      const id = p.id || p._id || p.userId || String(i);
                      const nm = p.name || p.fullName || "—";
                      const role = p.role || "pracownik";
                      return (
                        <div key={id} className="border border-gray-200 rounded-2xl p-4 flex items-center justify-between gap-3 hover:ring-2 hover:ring-brand-yellow/15 transition">
                          <div className="min-w-0">
                            <div className="font-extrabold text-gray-900 truncate">{nm}</div>
                            <div className="text-xs text-gray-500 mt-1">
                              ID: <span className="font-mono">{String(id)}</span> • {role}
                            </div>
                          </div>
                          <button
                            type="button"
                            onClick={() => remove(id)}
                            className="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft hover:ring-2 hover:ring-red-200 transition font-extrabold text-sm text-red-700"
                          >
                            <Icon name="trash-2" className="w-4 h-4" />
                            Usuń
                          </button>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    /* =======================
      Realtime: SSE + fallback polling
    ======================= */
    const useOrdersRealtime = ({ token, enabled, onNewOrder, getLatestOrder }) => {
      const esRef = useRef(null);
      const pollRef = useRef(null);

      const stopAll = () => {
        if (esRef.current) {
          try { esRef.current.close(); } catch {}
          esRef.current = null;
        }
        if (pollRef.current) {
          clearInterval(pollRef.current);
          pollRef.current = null;
        }
      };

      useEffect(() => {
        if (!enabled || !token) {
          stopAll();
          return;
        }

        try {
          const es = new EventSource(API.events, { withCredentials: false });
          esRef.current = es;

          es.onmessage = (ev) => {
            let data = null;
            try { data = JSON.parse(ev.data); } catch { data = null; }
            if (!data) return;
            if (data.type === "new_order") {
              const latest = getLatestOrder?.() || null;
              onNewOrder?.(latest, data);
            }
          };

          es.onerror = () => {
            try { es.close(); } catch {}
            esRef.current = null;

            if (!pollRef.current) {
              pollRef.current = setInterval(async () => {
                try {
                  const url = new URL(API.orders, window.location.origin);
                  const r = await fetch(url.toString(), { headers: { ...authHeader(token) } });
                  const data = await safeJson(r);
                  if (!r.ok) return;

                  const list = Array.isArray(data.orders) ? data.orders : [];
                  const newest = list[0];
                  if (newest) onNewOrder?.(newest, { type: "new_order", via: "poll" });
                } catch {}
              }, 4000);
            }
          };
        } catch (e) {
          if (!pollRef.current) {
            pollRef.current = setInterval(async () => {
              try {
                const url = new URL(API.orders, window.location.origin);
                const r = await fetch(url.toString(), { headers: { ...authHeader(token) } });
                const data = await safeJson(r);
                if (!r.ok) return;

                const list = Array.isArray(data.orders) ? data.orders : [];
                const newest = list[0];
                if (newest) onNewOrder?.(newest, { type: "new_order", via: "poll" });
              } catch {}
            }, 4000);
          }
        }

        return () => stopAll();
      }, [token, enabled]);
    };

    /* =======================
      App: main
    ======================= */
    const STORAGE_KEY = "eatmi-admin-token";

    const AppShell = ({ token, onLogout }) => {
      const toast = useToast();
      const [tab, setTab] = useState("dashboard");
      const [ordersCount, setOrdersCount] = useState(0);

      const [alertOpen, setAlertOpen] = useState(false);
      const [alertOrder, setAlertOrder] = useState(null);

      const latestOrderRef = useRef(null);

      useEffect(() => { window.lucide?.createIcons?.(); }, [tab, ordersCount, alertOpen]);

      const title = tab === "dashboard" ? "Dashboard" :
                    tab === "orders" ? "Zamówienia" :
                    tab === "push" ? "Powiadomienia push" :
                    tab === "staff" ? "Obsługa" : "Panel";

      const subtitle =
        tab === "dashboard" ? "Statystyki i szybki podgląd." :
        tab === "orders" ? "Wszystkie zamówienia i dane klienta." :
        tab === "push" ? "Wyślij powiadomienie na telefony użytkowników." :
        tab === "staff" ? "Zarządzaj dostępem pracowników." :
        "";

      const acknowledge = () => {
        const o = alertOrder;
        if (o) {
          const key = `${pickOrderId(o, 0)}|${pickCreatedAt(o) || ""}`;
          localStorage.setItem(STORAGE_LAST_ACK, JSON.stringify({ lastSeenKey: key, ts: Date.now() }));
        } else {
          localStorage.setItem(STORAGE_LAST_ACK, JSON.stringify({ lastSeenKey: "ack", ts: Date.now() }));
        }

        setAlertOpen(false);
        setAlertOrder(null);

        setTab("orders");
        toast.show("ok", "Powiadomienie", "Potwierdzono nowe zamówienie.");
      };

      const handleNewOrder = (orderObj, meta) => {
        const o = orderObj || latestOrderRef.current;
        if (!o) return;

        const newestKey = `${pickOrderId(o, 0)}|${pickCreatedAt(o) || ""}`;

        const rawAck = localStorage.getItem(STORAGE_LAST_ACK) || "";
        let ack = null;
        try { ack = rawAck ? JSON.parse(rawAck) : null; } catch { ack = null; }
        const lastSeenKey = ack?.lastSeenKey || "";

        if (!newestKey || newestKey === lastSeenKey) return;
        if (alertOpen) return;

        setAlertOrder(o);
        setAlertOpen(true);
      };

      useOrdersRealtime({
        token,
        enabled: true,
        onNewOrder: (orderObj, meta) => handleNewOrder(orderObj, meta),
        getLatestOrder: () => latestOrderRef.current,
      });

      const OrdersWithBridge = () => (
        <Orders
          token={token}
          setOrdersCount={(n)=>setOrdersCount(n)}
          onNewOrderDetected={(newest) => {
            latestOrderRef.current = newest || null;
            handleNewOrder(newest, { type: "new_order", via: "orders_load" });
          }}
        />
      );

      return (
        <div className="min-h-screen">
          <NewOrderOverlay
            open={alertOpen}
            orderPreview={alertOrder}
            onAcknowledge={acknowledge}
          />

          <div className={alertOpen ? "no-interact" : ""}>
            <div className="hidden md:flex">
              <aside className="fixed top-0 left-0 bottom-0 w-[var(--sidebar-w)] p-4">
                <div className="bg-white/85 border border-white/60 shadow-glass rounded-3xl p-4 h-full flex flex-col">
                  <Logo />

                  <div className="mt-5 space-y-2">
                    <NavItem
                      active={tab === "dashboard"}
                      icon="layout-dashboard"
                      label="Dashboard"
                      onClick={() => setTab("dashboard")}
                    />
                    <NavItem
                      active={tab === "orders"}
                      icon="shopping-bag"
                      label="Zamówienia"
                      badge={ordersCount}
                      onClick={() => setTab("orders")}
                    />
                    <NavItem
                      active={tab === "push"}
                      icon="bell"
                      label="Powiadomienia push"
                      onClick={() => setTab("push")}
                    />
                    <NavItem
                      active={tab === "staff"}
                      icon="users"
                      label="Obsługa"
                      onClick={() => setTab("staff")}
                    />
                  </div>

                  <div className="mt-auto pt-3">
                    <button
                      type="button"
                      onClick={onLogout}
                      className="w-full inline-flex items-center justify-center gap-2 bg-white border border-gray-200 rounded-2xl px-4 py-3 shadow-soft hover:ring-2 hover:ring-brand-yellow/25 transition font-extrabold text-sm"
                    >
                      <Icon name="log-out" className="w-4 h-4" />
                      Wyloguj
                    </button>

                    <div className="mt-3 text-xs text-gray-500 text-center">
                      eatmi.pl • panel administratora
                    </div>
                  </div>
                </div>
              </aside>

              <main className="ml-[var(--sidebar-w)] w-full">
                <Topbar title={title} subtitle={subtitle} onLogout={onLogout} />
                {tab === "dashboard" && <Dashboard token={token} />}
                {tab === "orders" && <OrdersWithBridge />}
                {tab === "push" && <Push token={token} />}
                {tab === "staff" && <Staff token={token} />}
              </main>
            </div>

            <div className="md:hidden">
              <Topbar title={title} subtitle={subtitle} onLogout={onLogout} />

              <div className="px-4 pt-4">
                <div className="bg-white/85 border border-white/60 shadow-glass rounded-3xl p-3 grid grid-cols-2 gap-2">
                  <button
                    className={`px-4 py-3 rounded-2xl border font-extrabold text-sm flex items-center gap-2 justify-center ${
                      tab==="dashboard" ? "bg-brand-yellow/20 border-brand-yellow/30" : "bg-white border-gray-200"
                    }`}
                    onClick={()=>setTab("dashboard")}
                  >
                    <Icon name="layout-dashboard" className="w-4 h-4" /> Dashboard
                  </button>
                  <button
                    className={`px-4 py-3 rounded-2xl border font-extrabold text-sm flex items-center gap-2 justify-center ${
                      tab==="orders" ? "bg-brand-yellow/20 border-brand-yellow/30" : "bg-white border-gray-200"
                    }`}
                    onClick={()=>setTab("orders")}
                  >
                    <Icon name="shopping-bag" className="w-4 h-4" /> Zamówienia
                    {ordersCount > 0 && (
                      <span className="ml-1 text-[10px] font-black px-2 py-0.5 rounded-full bg-gray-900 text-white">
                        {ordersCount > 99 ? "99+" : ordersCount}
                      </span>
                    )}
                  </button>
                  <button
                    className={`px-4 py-3 rounded-2xl border font-extrabold text-sm flex items-center gap-2 justify-center ${
                      tab==="push" ? "bg-brand-yellow/20 border-brand-yellow/30" : "bg-white border-gray-200"
                    }`}
                    onClick={()=>setTab("push")}
                  >
                    <Icon name="bell" className="w-4 h-4" /> Push
                  </button>
                  <button
                    className={`px-4 py-3 rounded-2xl border font-extrabold text-sm flex items-center gap-2 justify-center ${
                      tab==="staff" ? "bg-brand-yellow/20 border-brand-yellow/30" : "bg-white border-gray-200"
                    }`}
                    onClick={()=>setTab("staff")}
                  >
                    <Icon name="users" className="w-4 h-4" /> Obsługa
                  </button>
                </div>
              </div>

              {tab === "dashboard" && <Dashboard token={token} />}
              {tab === "orders" && <OrdersWithBridge />}
              {tab === "push" && <Push token={token} />}
              {tab === "staff" && <Staff token={token} />}
            </div>
          </div>
        </div>
      );
    };

    const Root = () => {
      const [token, setToken] = useState(() => localStorage.getItem(STORAGE_KEY) || "");

      useEffect(() => { window.lucide?.createIcons?.(); });

      const onAuth = (t) => {
        setToken(t);
        localStorage.setItem(STORAGE_KEY, t);
      };

      const logout = () => {
        setToken("");
        localStorage.removeItem(STORAGE_KEY);
      };

      return token ? <AppShell token={token} onLogout={logout} /> : <Login onAuth={onAuth} />;
    };

    ReactDOM.createRoot(document.getElementById("root")).render(
      <ToastProvider>
        <Root />
      </ToastProvider>
    );
  </script>
</body>
</html>
